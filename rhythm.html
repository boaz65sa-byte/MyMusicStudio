<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Cube V1</title>
    <style>
        body { background: #121212; color: #eee; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        
        /* --- ×¢×™×¦×•×‘ ×”×§×•×‘×™×™×” --- */
        .rhythm-cube {
            background: #1e1e1e;
            width: 320px;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #444;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
        }

        .title { color: #ffb300; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* ×›×¤×ª×•×¨×™× ×•×©×œ×™×˜×” */
        .controls { display: flex; flex-direction: column; gap: 10px; }
        
        select, button, input[type=range] {
            width: 100%; height: 32px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; cursor: pointer; outline: none; font-size: 14px;
        }
        
        button.play-btn { background: #4caf50; font-weight: bold; border: none; }
        button.play-btn.playing { background: #f44336; } /* ××“×•× ×›×©×× ×’×Ÿ */
        
        .row { display: flex; gap: 5px; align-items: center; justify-content: space-between; }
        label { font-size: 12px; color: #aaa; }

        /* × ×’×Ÿ MP3 */
        .mp3-zone {
            margin-top: 15px; padding-top: 10px; border-top: 1px dashed #444;
        }
        .file-input { display: none; }
        .file-label {
            display: block; background: #455a64; color: white; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-bottom: 5px;
        }
        .file-label:hover { background: #607d8b; }

        /* ×•×™×–×•××œ×™×–×¦×™×” ×©×œ ×”×‘×™×˜ */
        .beat-display {
            display: flex; gap: 2px; margin-top: 10px; height: 10px; justify-content: center;
        }
        .beat-dot { width: 8px; height: 8px; background: #333; border-radius: 50%; }
        .beat-dot.active { background: #ffb300; box-shadow: 0 0 5px #ffb300; }
        .beat-dot.strong { width: 10px; height: 10px; }

    </style>
</head>
<body>

<div class="rhythm-cube">
    <div class="title">ğŸ¥ ××›×•× ×ª ×§×¦×‘ ×•× ×’×Ÿ</div>
    
    <div class="controls">
        <select id="styleSelect" onchange="changeStyle()">
            <optgroup label="--- ×™×•×•× ×™ ---">
                <option value="zeibekiko">×–×™×™×‘×§×™×§×• (9/8)</option>
                <option value="hasapiko">×—×¡×¤×™×§×• (4/4)</option>
                <option value="tsifteteli">×¦×¤×˜×˜×œ×™ (4/4)</option>
                <option value="kalamatianos">×§×œ××˜×™×× ×•×¡ (7/8)</option>
            </optgroup>
            <optgroup label="--- ××–×¨×—×™ ---">
                <option value="maksum">××§×¡×•× (4/4)</option>
                <option value="baladi">×‘×œ×“×™ (4/4)</option>
                <option value="saidi">×¡×¢×™×“×™ (4/4)</option>
                <option value="laf">×œ××£ (2/4)</option>
            </optgroup>
            <optgroup label="--- ××¢×¨×‘×™ ---">
                <option value="rock">×¨×•×§ ×‘×¡×™×¡×™ (4/4)</option>
                <option value="waltz">×•××œ×¡ (3/4)</option>
                <option value="disco">×“×™×¡×§×• (4/4)</option>
            </optgroup>
        </select>

        <div class="row">
            <label>BPM: <span id="bpmVal">120</span></label>
            <input type="range" id="bpmRange" min="40" max="200" value="120" oninput="updateBPM()">
        </div>

        <button id="playBtn" class="play-btn" onclick="togglePlay()">â–¶ × ×’×Ÿ ××§×¦×‘</button>
        
        <div id="beatVis" class="beat-display"></div>
    </div>

    <div class="mp3-zone">
        <div class="title" style="font-size: 12px; border:none; margin-bottom: 5px;">× ×’×Ÿ ×œ×™×•×•×™ (Backing Track)</div>
        <label for="fileUpload" class="file-label">ğŸ“‚ ×˜×¢×Ÿ ×§×•×‘×¥ (MP3/WAV)</label>
        <input type="file" id="fileUpload" class="file-input" accept="audio/*" onchange="loadAudioFile(this)">
        
        <audio id="audioPlayer" controls style="width: 100%; height: 30px; margin-top: 5px;"></audio>
        <div id="fileName" style="font-size: 10px; color: #888; margin-top: 2px;">××™×Ÿ ×§×•×‘×¥</div>
    </div>
</div>

<script>
    // --- ×× ×•×¢ ××•×“×™×• (Synthesizer) ---
    let audioCtx;
    let isPlaying = false;
    let currentBeat = 0;
    let nextNoteTime = 0;
    let timerID;
    let bpm = 120;
    let rhythmPattern = []; // 1=Dum, 2=Tak, 0=Rest
    
    // ×”×’×“×¨×•×ª ×”××§×¦×‘×™× (1=×“×•× ×‘×¡, 2=×˜××§ ×’×‘×•×”, 0=×©×§×˜)
    const RHYTHMS = {
        // ×™×•×•× ×™
        'zeibekiko': [1, 0, 0, 2, 0, 1, 0, 2, 0, 2, 0, 0], // 9/8 ×¤×©×•×˜ (×“×•×’××”)
        'hasapiko': [1, 0, 2, 0, 1, 0, 2, 0], // 4/4 ××”×™×¨
        'tsifteteli': [1, 0, 2, 0, 2, 0, 1, 0, 2, 0, 0, 0], 
        'kalamatianos': [1, 0, 2, 1, 0, 2, 0], // 7/8 (3+2+2)
        
        // ××–×¨×—×™
        'maksum': [1, 0, 2, 0, 0, 2, 1, 0, 2, 0, 0, 0],
        'baladi': [1, 0, 1, 0, 0, 2, 1, 0, 0, 0, 2, 0],
        'saidi': [1, 0, 2, 0, 1, 1, 0, 0, 2, 0, 0, 0],
        'laf': [1, 0, 2, 0],

        // ××¢×¨×‘×™
        'rock': [1, 0, 2, 0, 1, 0, 2, 0],
        'waltz': [1, 0, 2, 0, 2, 0],
        'disco': [1, 0, 0, 0, 2, 0, 0, 0]
    };

    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioCtx.resume();
    }

    // ×™×¦×™×¨×ª ×¦×œ×™×œ ×ª×•×£ (×¡×™× ×ª×–×”)
    function playDrum(type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;

        if (type === 1) { // DUM (Bass)
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.5);
            gain.gain.setValueAtTime(1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
        } else if (type === 2) { // TAK (Snare/High)
            osc.type = 'square'; // ×¡××•× ×“ ×—×“ ×™×•×ª×¨
            osc.frequency.setValueAtTime(800, now); // ×ª×“×¨ ×’×‘×•×”
            osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.1);
            gain.gain.setValueAtTime(0.3, now); // ×—×œ×© ×™×•×ª×¨
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        }

        osc.start(now);
        osc.stop(now + 0.5);
    }

    // --- ×× ×•×¢ ×”×ª×™×–××•×Ÿ (Scheduler) ---
    function nextNote() {
        const secondsPerBeat = 60.0 / bpm;
        // ×—×™×œ×•×§ ×”××§×¦×‘ ×œ-16 ××• 8 ×‘×”×ª×× ×œ××•×¨×›×‘×•×ª (×›××Ÿ ×¤×™×©×˜×ª×™ ×œ×—×œ×§×™ 4/8 ×œ×›×œ ×‘×™×˜)
        nextNoteTime += 0.25 * (120 / bpm); // ×—×™×©×•×‘ ×’×¡ ×œ××”×™×¨×•×ª ×™×—×¡×™×ª
    }

    function scheduler() {
        // Lookahead: ×× ×”×¦×œ×™×œ ×”×‘× ×¦×¨×™×š ×œ×§×¨×•×ª ×‘×§×¨×•×‘, × ×ª×–××Ÿ ××•×ª×•
        while (nextNoteTime < audioCtx.currentTime + 0.1) {
            scheduleNote(currentBeat, nextNoteTime);
            
            // ×—×™×©×•×‘ ×”×–××Ÿ ×”×‘× ×‘×¦×•×¨×” ×¤×©×•×˜×” ×™×•×ª×¨ (Interval)
            // ×œ×¦×•×¨×š ×”×“×•×’××” ×”×¤×©×•×˜×” × ×©×ª××© ×‘-SetInterval ×‘×—×•×¥ ×œ×©×œ×™×˜×” ×•×™×–×•××œ×™×ª ×•×¡××•× ×“
            // ×‘×’×¨×¡×” ××§×¦×•×¢×™×ª ××©×ª××©×™× ×‘×—×™×©×•×‘ ××“×•×™×§ ×™×•×ª×¨
            nextNoteTime += (60.0 / bpm) / 2; // ×©××™× ×™×•×ª
            
            // ×§×™×“×•× ×”×‘×™×˜
            currentBeat++;
            if (currentBeat >= rhythmPattern.length) currentBeat = 0;
        }
        timerID = window.setTimeout(scheduler, 25.0);
    }
    
    // ×¤×•× ×§×¦×™×” ×¤×©×•×˜×” ×™×•×ª×¨ ××‘×•×¡×¡×ª Interval ×œ×’×¨×¡×” ×–×• (×™×¦×™×‘×” ××¡×¤×™×§ ×œ×“×¤×“×¤×Ÿ)
    let beatInterval;
    function startRhythm() {
        let pattern = RHYTHMS[document.getElementById('styleSelect').value];
        rhythmPattern = pattern;
        updateVis();
        
        let i = 0;
        // ×—×™×©×•×‘ ×–××Ÿ ×‘×™×Ÿ ×¤×¢××•×ª (×‘××™×œ×™×©× ×™×•×ª) - ××•×ª×× ×œ×—×œ×§×™ 16 ××• 8
        let speed = (60000 / bpm) / 2; // ×©××™× ×™×•×ª

        beatInterval = setInterval(() => {
            // ×•×™×–×•××œ×™×–×¦×™×”
            document.querySelectorAll('.beat-dot').forEach((d, idx) => {
                d.classList.toggle('active', idx === i);
            });

            // × ×’×™× ×”
            if (pattern[i] !== 0) playDrum(pattern[i]);

            i++;
            if (i >= pattern.length) i = 0;
        }, speed);
    }

    function togglePlay() {
        initAudio();
        const btn = document.getElementById('playBtn');
        
        if (isPlaying) {
            clearInterval(beatInterval);
            isPlaying = false;
            btn.innerText = "â–¶ × ×’×Ÿ ××§×¦×‘";
            btn.classList.remove('playing');
            document.querySelectorAll('.beat-dot').forEach(d => d.classList.remove('active'));
        } else {
            bpm = document.getElementById('bpmRange').value;
            startRhythm();
            isPlaying = true;
            btn.innerText = "â–  ×¢×¦×•×¨";
            btn.classList.add('playing');
        }
    }

    function updateBPM() {
        bpm = document.getElementById('bpmRange').value;
        document.getElementById('bpmVal').innerText = bpm;
        if (isPlaying) {
            clearInterval(beatInterval);
            startRhythm();
        }
    }

    function changeStyle() {
        if (isPlaying) {
            clearInterval(beatInterval);
            startRhythm();
        } else {
            updateVis(); // ×¨×§ ×¢×“×›×•×Ÿ ×•×™×–×•××œ×™
        }
    }

    // ×™×¦×™×¨×ª ×”× ×§×•×“×•×ª ×”×•×™×–×•××œ×™×•×ª
    function updateVis() {
        const pattern = RHYTHMS[document.getElementById('styleSelect').value];
        const vis = document.getElementById('beatVis');
        vis.innerHTML = '';
        pattern.forEach(note => {
            let d = document.createElement('div');
            d.className = 'beat-dot ' + (note === 1 ? 'strong' : '');
            vis.appendChild(d);
        });
    }

    // --- × ×’×Ÿ MP3 ---
    function loadAudioFile(input) {
        const file = input.files[0];
        if (file) {
            const url = URL.createObjectURL(file);
            const player = document.getElementById('audioPlayer');
            player.src = url;
            document.getElementById('fileName').innerText = file.name;
        }
    }

    // ××ª×—×•×œ ×¨××©×•× ×™
    updateVis();

</script>

</body>
</html>