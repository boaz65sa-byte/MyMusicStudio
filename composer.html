<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1000, initial-scale=1">
    <title>Boaz Composer V52 - Hybrid Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap');
        
        * { box-sizing:border-box; user-select:none; margin:0; padding:0; }

        body { 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #eee; 
            font-family: 'Heebo', 'Segoe UI', sans-serif; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            min-height: 100vh;
        }

        /* --- ×¡×¨×’×œ × ×™×•×•×˜ ×¢×œ×™×•×Ÿ --- */
        .top-nav { width: 100%; max-width: 1200px; display: flex; gap: 10px; margin-bottom: 20px; justify-content: flex-end; z-index: 100; }
        .nav-btn { text-decoration:none; font-size:14px; background:rgba(255,255,255,0.1); color:white; padding:8px 15px; border-radius:20px; border:1px solid rgba(255,255,255,0.2); cursor: pointer; display:flex; align-items:center; gap:5px; transition:0.3s; backdrop-filter: blur(5px); }
        .nav-btn:hover { background: rgba(255,255,255,0.2); border-color: #ffb300; }

        /* Header */
        h1 { 
            color: #ffb300; font-weight: 900; font-size: 32px; letter-spacing: 2px; text-transform: uppercase;
            text-shadow: 0 0 20px rgba(255, 179, 0, 0.5); margin-bottom: 20px;
        }

        /* Control Panel (×¢×™×¦×•×‘ ××”×§×•×‘×¥ ×”×—×“×©) */
        .control-panel {
            width: 100%; max-width: 1200px;
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px);
            padding: 20px; border-radius: 15px; border: 1px solid #444;
            margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .control-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; justify-content: center; }

        /* ×›×¤×ª×•×¨×™× ××©×•×“×¨×’×™× */
        button { 
            background: linear-gradient(135deg, #37474f, #263238); color: white;
            border: 1px solid #546e7a; padding: 10px 20px; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: all 0.3s; font-family: 'Heebo', sans-serif;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.4); filter: brightness(1.1); }
        
        .btn-gold { background: linear-gradient(135deg, #ffb300, #ff8f00); color: black; border-color: #ffd54f; }
        .btn-green { background: linear-gradient(135deg, #2e7d32, #1b5e20); border-color: #4caf50; }
        .btn-red { background: linear-gradient(135deg, #c62828, #b71c1c); border-color: #ef5350; }
        .btn-blue { background: linear-gradient(135deg, #1976d2, #0d47a1); border-color: #42a5f5; }
        .btn-active { animation: pulse 1.5s infinite; border-color: #ffb300; box-shadow: 0 0 15px #ffb300; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 179, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 179, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 179, 0, 0); } }

        input[type="text"] { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; padding: 10px; border-radius: 6px; font-size: 16px; direction: ltr; }
        select { background: #222; color: #ffb300; border: 1px solid #555; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* Sliders */
        .audio-controls {
            display: flex; gap: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3);
            border-radius: 10px; border: 1px solid rgba(255, 179, 0, 0.1); width: 100%; justify-content: center;
        }
        .slider-group { display: flex; align-items: center; gap: 10px; color: #aaa; font-size: 14px; }
        input[type="range"] { width: 120px; height: 5px; accent-color: #ffb300; cursor: pointer; }

        /* Sheet Area */
        .sheet-wrapper { 
            width: 100%; max-width: 1200px; overflow-x: auto; background: #fff; 
            border-radius: 12px; margin-bottom: 20px; box-shadow: 0 0 40px rgba(255, 255, 255, 0.05); 
            border: 4px solid #333; position: relative; 
        }
        .notation-panel { min-width: 1000px; position: relative; transition: height 0.3s; }
        svg { width: 100%; height: auto; display: block; }
        
        .staff-line { stroke: #444; stroke-width: 1; }
        .tab-line { stroke: #666; stroke-width: 1; }
        .note-head { fill: #000; stroke: #000; cursor: pointer; transition: 0.2s; }
        .note-head:hover { fill: #2196f3; stroke: #2196f3; }
        
        #playCursor { position: absolute; top: 0; bottom: 0; width: 3px; background: rgba(255, 0, 0, 0.6); pointer-events: none; display: none; z-index: 100; transition: left 0.1s linear; }

        /* Instruments (×”×¢×™×¦×•×‘ ×”××§×•×¨×™ ×©×œ×š) */
        .inst-label { width: 100%; max-width: 1200px; text-align: right; color: #ffb300; font-size: 14px; margin: 10px 0 5px 0; font-weight: bold; border-bottom: 1px solid #333; }
        .instrument { position: relative; width: 100%; max-width: 1200px; margin-bottom: 10px; background: #0a0a0a; border: 2px solid #333; border-radius: 6px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: height 0.3s, opacity 0.3s; }
        
        .hidden-inst { height: 0; margin: 0; border: none; opacity: 0; pointer-events: none; }
        .hidden-lbl { display: none; }

        .bouzouki-neck { height: 140px; display: flex; position: relative; background: #1a1005; cursor: pointer; }
        .bouzouki-neck .string { position: absolute; left: 0; right: 0; height: 2px; background: #999; box-shadow: 0 1px 2px black; }
        .bouzouki-neck .fret { position: absolute; top: 0; bottom: 0; width: 2px; background: #666; }
        
        .guitar-neck { height: 160px; display: flex; position: relative; background: #2d1a10; cursor: pointer; opacity: 0.95; }
        .guitar-neck .string { position: absolute; left: 0; right: 0; height: 1px; background: #bcaaa4; }
        .guitar-neck .fret { position: absolute; top: 0; bottom: 0; width: 2px; background: #8d6e63; }

        .piano-keys { height: 100px; display: flex; position: relative; background: #000; cursor: pointer; opacity: 0.9; }
        .p-key-white { flex: 1; background: #fff; border: 1px solid #999; border-radius: 0 0 3px 3px; position: relative; }
        .p-key-black { width: 60%; height: 60%; background: #000; position: absolute; top: 0; left: -30%; z-index: 10; border-radius: 0 0 3px 3px; }

        /* Markers (×¢×™×¦×•×‘ ××•×“×¨× ×™ ×™×•×ª×¨) */
        .marker { position: absolute; width: 22px; height: 22px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 11px; font-weight: bold; transform: translate(-50%, -50%); z-index: 10; background: #222; border: 1px solid #444; color: #888; }
        .bz-marker { background: #333; color: white; border: 1px solid #666; opacity: 1; }
        .bz-marker:hover { background: #ffb300; color: black; z-index: 60; transform: translate(-50%, -50%) scale(1.3); }
        
        @keyframes pop { 0% { transform: translate(-50%, -50%) scale(1.5); background: #ffb300; color: black; box-shadow: 0 0 20px #ffb300; } 100% { transform: translate(-50%, -50%) scale(1); background: #333; color: white; } }
        .play-active { animation: pop 0.4s ease-out forwards; }
        .click-zone { position: absolute; width: 4.8%; height: 25%; z-index: 20; cursor: pointer; }
        .click-zone:hover { background: rgba(255, 255, 255, 0.1); }
        #fileInput { display: none; }

        /* --- Voice Visualizer (××”×§×•×‘×¥ ×”×—×“×©) --- */
        .voice-visualizer {
            position: fixed; bottom: 20px; right: 20px; width: 200px; height: 100px;
            background: rgba(0, 0, 0, 0.9); border: 2px solid #2196f3; border-radius: 12px;
            padding: 10px; display: none; flex-direction: column; gap: 5px; z-index: 999;
            box-shadow: 0 0 30px rgba(33, 150, 243, 0.4); backdrop-filter: blur(5px);
        }
        .voice-visualizer.active { display: flex; }
        .voice-bars { display: flex; gap: 4px; height: 40px; align-items: flex-end; justify-content: center; }
        .voice-bar { width: 8px; background: #2196f3; border-radius: 4px; animation: voicePulse 0.5s ease-in-out infinite alternate; }
        .voice-bar:nth-child(1) { animation-delay: 0s; } .voice-bar:nth-child(2) { animation-delay: 0.1s; } .voice-bar:nth-child(3) { animation-delay: 0.2s; }
        @keyframes voicePulse { 0% { height: 5px; } 100% { height: 35px; } }
        .voice-text { text-align: center; color: #2196f3; font-weight: bold; font-size: 18px; }

        @media print {
            body { background: white; padding: 0; }
            h1, .top-nav, .control-panel, .inst-label, .instrument, #playCursor, .voice-visualizer { display: none !important; }
            .sheet-wrapper { box-shadow: none; border: none; width: 100%; margin: 0; }
            svg { width: 100%; height: auto; }
        }
    </style>
</head>
<body>

    <div class="top-nav">
        <button class="nav-btn" onclick="window.open('tuner.html','T','width=400,height=600')">ğŸ¤ ×˜×™×•× ×¨</button>
        <button class="nav-btn" onclick="window.open('metronome.html','M','width=400,height=600')">â±ï¸ ××˜×¨×•× ×•×</button>
        <a href="index.html" class="nav-btn" style="background:#d32f2f;">ğŸ  ×™×¦×™××”</a>
    </div>

    <h1>ğŸµ Boaz Composer Pro</h1>

    <div class="control-panel">
        <div class="control-row">
            <input type="text" id="txtInput" placeholder="×”×§×œ×“ ×ª×•×•×™×: Do Re Mi... ××• ×”×©×ª××© ×‘××™×§×¨×•×¤×•×Ÿ">
            <button onclick="parseAndAdd()" class="btn-green">âœ“ ×”×•×¡×£</button>
            <button onclick="addRest()" class="btn-blue">â¸ ×”×¤×¡×§×”</button>
            <button onclick="undoLast()" class="btn-orange">â†¶ ××—×§ ××—×¨×•×Ÿ</button>
            <button onclick="clearSong()" class="btn-red">âœ• × ×§×” ×”×›×œ</button>
        </div>

        <div class="control-row audio-controls">
            <div class="slider-group">
                <label>ğŸ”Š Volume:</label>
                <input type="range" id="volumeSlider" min="0" max="100" value="70" oninput="updateVolume()">
            </div>
            <div class="slider-group">
                <label>âš¡ BPM:</label>
                <input type="range" id="bpmSlider" min="40" max="200" value="120" oninput="updateBPM()">
                <span id="bpmDisplay" style="color:#ffb300; font-weight:bold; width:30px;">120</span>
            </div>
        </div>

        <div class="control-row">
            <select id="scoreLayout" onchange="renderSheet()">
                <option value="all">×ª×¦×•×’×” ××œ××” (×ª×•×•×™× + ×›×œ×™×)</option>
                <option value="bz">×‘×•×–×•×§×™ ×‘×œ×‘×“</option>
                <option value="gtr">×’×™×˜×¨×” ×‘×œ×‘×“</option>
            </select>

            <button onclick="togglePlay()" id="playBtn" class="btn-green">â–¶ × ×’×Ÿ</button>
            <button onclick="stopAndReset()" class="btn-red">â¹ ×¢×¦×•×¨</button>
            <button onclick="toggleVoiceRecognition()" id="voiceBtn" class="btn-gold">ğŸ¤ ×–×™×”×•×™ ×§×•×œ×™</button>
        </div>

        <div class="control-row">
            <button onclick="saveSong()" class="btn-blue">ğŸ’¾ ×©××•×¨ ×§×•×‘×¥</button>
            <button onclick="document.getElementById('fileInput').click()" class="btn-blue">ğŸ“‚ ×˜×¢×Ÿ ×§×•×‘×¥</button>
            <button onclick="exportMIDI()" class="btn-blue">ğŸ¹ MIDI</button>
            <button onclick="window.print()" class="btn-blue">ğŸ–¨ ×”×“×¤×¡ PDF</button>
            <input type="file" id="fileInput" accept=".json" onchange="loadSong(this)">
        </div>
    </div>

    <div class="sheet-wrapper" id="sheetWrapper">
        <div id="playCursor"></div>
        <div class="notation-panel" id="notationPanel">
            <svg id="mainSvg"></svg>
        </div>
    </div>

    <div id="lbl-bz" class="inst-label">×‘×•×–×•×§×™ (Bouzouki)</div>
    <div id="inst-bz" class="instrument bouzouki-neck" id="bouzoukiBoard"></div>

    <div id="lbl-gtr" class="inst-label">×’×™×˜×¨×” (Guitar)</div>
    <div id="inst-gtr" class="instrument guitar-neck" id="guitarBoard"></div>

    <div id="lbl-pno" class="inst-label">×¤×¡× ×ª×¨ (Piano)</div>
    <div id="inst-pno" class="instrument piano-keys" id="pianoBoard"></div>

    <div class="voice-visualizer" id="voiceVisualizer">
        <div class="voice-bars">
            <div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div>
        </div>
        <div class="voice-text" id="detectedNote">--</div>
        <div style="text-align:center; font-size:10px; color:#aaa;">××§×©×™×‘...</div>
    </div>

<script>
    const AUDIO = new (window.AudioContext || window.webkitAudioContext)();
    let songData = [];
    let isPlaying = false;
    let playIndex = 0;
    let playTimeout = null;
    let currentVolume = 0.7;

    const NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const NOTE_MAP = {'do':0,'re':2,'mi':4,'fa':5,'sol':7,'la':9,'si':11,'c':0,'d':2,'e':4,'f':5,'g':7,'a':9,'b':11};
    const BZ_STRINGS = [48, 53, 57, 62]; 
    const GTR_STRINGS = [40, 45, 50, 55, 59, 64]; 
    const PIANO_START = 36;
    const START_X = 80; const NOTE_SPACING = 50; const STAFF_TOP_Y = 40;

    // --- ENHANCED AUDIO ENGINE (Synthesized Harmonics) ---
    function playSoundEnhanced(midi, duration, instrument='bouzouki') {
        const now = AUDIO.currentTime;
        const freq = 440 * Math.pow(2, (midi - 69) / 12);
        
        // ×”×’×“×¨×ª ×”×¨××•× ×™×•×ª ×œ×¤×™ ×›×œ×™ (×›×“×™ ×©×–×” ×œ× ×™×©××¢ "×–×•×œ")
        let harmonics = [1.0]; // ×‘×¨×™×¨×ª ××—×“×œ
        let waveform = 'triangle';
        let envelope = { att: 0.01, dec: 0.1, sus: 0.5, rel: 0.3 };

        if(instrument === 'bouzouki') {
            harmonics = [1.0, 0.5, 0.3, 0.2]; // ×¦×œ×™×œ ××ª×›×ª×™ ×¢×©×™×¨
            waveform = 'sawtooth';
            envelope = { att: 0.005, dec: 0.1, sus: 0.4, rel: 0.2 }; // ×¤×¨×™×˜×” ××”×™×¨×”
        } else if(instrument === 'guitar') {
            harmonics = [1.0, 0.4, 0.2];
            waveform = 'triangle';
            envelope = { att: 0.01, dec: 0.2, sus: 0.5, rel: 0.4 };
        } else { // Piano
            harmonics = [1.0, 0.6, 0.4, 0.2];
            envelope = { att: 0.002, dec: 0.3, sus: 0.3, rel: 0.5 };
        }

        // ×™×¦×™×¨×ª ××•×¡×™×œ×˜×•×¨×™× ×œ×›×œ ×”×¨××•× ×™×”
        harmonics.forEach((amp, i) => {
            const osc = AUDIO.createOscillator();
            const gain = AUDIO.createGain();
            osc.type = waveform;
            osc.frequency.value = freq * (i + 1);
            
            const vol = currentVolume * amp * 0.2; // ×”× ××›×ª ×•×•×œ×™×•× ×›×œ×œ×™
            
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(vol, now + envelope.att);
            gain.gain.linearRampToValueAtTime(vol * envelope.sus, now + envelope.att + envelope.dec);
            gain.gain.linearRampToValueAtTime(0, now + duration);
            
            osc.connect(gain);
            gain.connect(AUDIO.destination);
            osc.start(now);
            osc.stop(now + duration);
        });
    }

    // --- LOGIC ---
    window.onload = () => {
        buildBouzouki(); buildGuitar(); buildPiano(); renderSheet();
        document.getElementById('txtInput').addEventListener("keyup", (e) => { if (e.key === "Enter") parseAndAdd(); });
        document.addEventListener("keydown", (e) => { 
            if (e.key === "Backspace" && document.activeElement.tagName !== "INPUT") undoLast(); 
            if (e.code === "Space" && document.activeElement.tagName !== "INPUT") { e.preventDefault(); togglePlay(); }
        });
    };

    function updateVolume() { currentVolume = document.getElementById('volumeSlider').value / 100; }
    function updateBPM() { document.getElementById('bpmDisplay').innerText = document.getElementById('bpmSlider').value; }

    // --- INSTRUMENT BUILDING (×”×§×•×“ ×”×™×¦×™×‘ ×©×œ×š) ---
    function buildBouzouki() {
        const board = document.getElementById('inst-bz');
        for(let f=0; f<=20; f++) {
            let d=document.createElement('div'); d.className='fret'; d.style.left=(f*4.8)+'%'; board.appendChild(d);
            if([3,5,7,9,12,15,17,19].includes(f)){
                let n=document.createElement('div'); n.innerText=f; n.style.position='absolute'; n.style.bottom='2px'; n.style.left=(f*4.8+2.4)+'%'; n.style.color='#888'; n.style.fontSize='10px'; n.style.transform='translateX(-50%)'; board.appendChild(n);
            }
        }
        for(let s=0; s<4; s++) { 
            let str=document.createElement('div'); str.className='string'; str.style.top=(20+s*20)+'%'; board.appendChild(str);
            for(let f=0; f<=20; f++) {
                let noteVal = BZ_STRINGS[3-s] + f;
                let zone = document.createElement('div'); zone.className = 'click-zone'; zone.style.left = (f*4.8)+'%'; zone.style.top = (s*25)+'%';
                zone.onclick = (e) => { e.stopPropagation(); addNote(noteVal, 3-s, f); };
                board.appendChild(zone);
                // Marker creation on demand in renderSheet to avoid clutter
                let mk = document.createElement('div'); mk.className='marker bz-marker hidden-marker'; mk.id=`bz-${3-s}-${f}`; mk.style.left=(f*4.8+2.4)+'%'; mk.style.top=(20+s*20)+'%'; mk.innerText = NOTES[noteVal%12];
                board.appendChild(mk);
            }
        }
    }

    function buildGuitar() {
        const board = document.getElementById('inst-gtr');
        for(let f=0; f<=20; f++) { let d=document.createElement('div'); d.className='fret'; d.style.left=(f*4.8)+'%'; board.appendChild(d); }
        for(let s=0; s<6; s++) {
            let str=document.createElement('div'); str.className='string'; str.style.top=(10+s*15)+'%'; board.appendChild(str);
            for(let f=0; f<=20; f++) {
                let noteVal = GTR_STRINGS[5-s] + f;
                let mk = document.createElement('div'); mk.className = 'marker gtr-marker'; mk.id = 'gtr-' + noteVal; mk.innerText = NOTES[noteVal % 12]; mk.style.left = (f * 4.8 + 2.4) + '%'; mk.style.top = (10 + s * 15) + '%';
                mk.style.cursor = 'pointer'; mk.onclick = (e) => { e.stopPropagation(); addNoteFromExternal(noteVal); };
                board.appendChild(mk);
            }
        }
    }

    function buildPiano() {
        const board = document.getElementById('inst-pno');
        for(let i=0; i<40; i++) {
            let noteVal = PIANO_START + i; let idx = noteVal % 12; let isBlack = [1,3,6,8,10].includes(idx);
            if(!isBlack) {
                let key = document.createElement('div'); key.className='p-key-white'; key.id='pno-'+noteVal;
                key.onclick = () => addNoteFromExternal(noteVal);
                if([1,3,6,8,10].includes((noteVal+1)%12)) {
                    let bKey = document.createElement('div'); bKey.className='p-key-black'; bKey.id='pno-'+(noteVal+1);
                    bKey.onclick = (e) => { e.stopPropagation(); addNoteFromExternal(noteVal+1); };
                    key.appendChild(bKey); i++;
                }
                board.appendChild(key);
            }
        }
    }

    // --- CORE FUNCTIONS ---
    function addNote(midi, string, fret) {
        let name = NOTES[midi%12];
        let gtrPos = calcGuitarPos(midi);
        songData.push({ type: 'note', midi, name, string, fret, pick: 'down', gtrString: gtrPos?.s, gtrFret: gtrPos?.f });
        playSoundEnhanced(midi, 0.3, 'bouzouki');
        highlightInstruments(midi, 300);
        
        let m = document.getElementById(`bz-${string}-${fret}`);
        if(m) { m.classList.remove('hidden-marker'); m.classList.add('play-active'); setTimeout(()=>m.classList.remove('play-active'), 400); }
        
        renderSheet(); scrollToEnd();
    }

    function addNoteFromExternal(midi) {
        let bestPos = findBestPosition(midi % 12, midi);
        if(bestPos) addNote(bestPos.midi, bestPos.string, bestPos.fret);
        else addNote(midi, 3, 0); // Fallback
    }

    function addRest() { songData.push({ type: 'rest' }); renderSheet(); scrollToEnd(); }
    function undoLast() { if(songData.length>0) { songData.pop(); renderSheet(); } }
    function clearSong() { songData = []; stopAndReset(); renderSheet(); }

    function findBestPosition(noteIndex, specificMidi = null) {
        if (specificMidi) {
            for (let s = 3; s >= 0; s--) {
                const base = BZ_STRINGS[s];
                const fret = specificMidi - base;
                if (fret >= 0 && fret <= 20) return { midi: specificMidi, string: s, fret: fret };
            }
        }
        return null;
    }
    function calcGuitarPos(midi) { for(let s=0; s<6; s++) { let open = GTR_STRINGS[s]; let f = midi - open; if(f >= 0 && f <= 15) return { s: s, f: f }; } return null; }

    // --- RENDER ---
    function renderSheet() {
        const layout = document.getElementById('scoreLayout').value;
        const svg = document.getElementById('mainSvg');
        const w = Math.max(1000, START_X + songData.length * NOTE_SPACING + 100);
        const h = layout === 'all' ? 440 : 320;
        
        document.getElementById('notationPanel').style.width = w + 'px';
        document.getElementById('notationPanel').style.height = h + 'px';
        svg.setAttribute('viewBox', `0 0 ${w} ${h}`); svg.setAttribute('width', w); svg.setAttribute('height', h);

        let html = '';
        // Staff
        for(let i=0; i<5; i++) { let y = STAFF_TOP_Y + i*10; html += `<line x1="20" y1="${y}" x2="${w-20}" y2="${y}" class="staff-line" />`; }
        html += `<text x="40" y="${STAFF_TOP_Y+35}" style="font-size: 60px;">ğŸ¼</text>`;

        let drawBz = (layout === 'all' || layout === 'bz');
        let drawGtr = (layout === 'all' || layout === 'gtr');
        let bzY = 200; let gtrY = layout === 'all' ? 320 : 200;

        // Visibility toggles
        document.getElementById('lbl-bz').classList.toggle('hidden-lbl', !drawBz);
        document.getElementById('inst-bz').classList.toggle('hidden-inst', !drawBz);
        document.getElementById('lbl-gtr').classList.toggle('hidden-lbl', !drawGtr);
        document.getElementById('inst-gtr').classList.toggle('hidden-inst', !drawGtr);

        if(drawBz) {
            html += `<text x="20" y="${bzY-15}" class="section-lbl">Bouzouki</text>`;
            for(let i=0; i<4; i++) { let y = bzY + i*20; html += `<line x1="50" y1="${y}" x2="${w-20}" y2="${y}" class="tab-line" />`; }
            html += `<line x1="50" y1="${STAFF_TOP_Y}" x2="50" y2="${bzY+60}" stroke="#000" stroke-width="2" />`;
        }
        if(drawGtr) {
            html += `<text x="20" y="${gtrY-15}" class="section-lbl">Guitar</text>`;
            for(let i=0; i<6; i++) { let y = gtrY + i*20; html += `<line x1="50" y1="${y}" x2="${w-20}" y2="${y}" class="tab-line" />`; }
            let topConnect = drawBz ? bzY+60 : STAFF_TOP_Y;
            html += `<line x1="50" y1="${topConnect}" x2="50" y2="${gtrY+100}" stroke="#000" stroke-width="2" />`;
        }

        songData.forEach((d, i) => {
            let x = START_X + i * NOTE_SPACING;
            if(d.type === 'rest') {
                html += `<rect x="${x-6}" y="${STAFF_TOP_Y+15}" width="12" height="10" fill="black" />`;
            } else {
                const mapC = {0:0, 1:0, 2:1, 3:1, 4:2, 5:3, 6:3, 7:4, 8:4, 9:5, 10:5, 11:6};
                let octaveDiff = Math.floor(d.midi/12) - 4;
                let step = mapC[d.midi%12];
                let y = (STAFF_TOP_Y + 50) - ((octaveDiff * 7 + step) * 5);
                
                html += `<ellipse cx="${x}" cy="${y}" rx="6" ry="4" class="note-head" onmousedown="showHint(${d.midi})" />`;
                html += `<line x1="${x+6}" y1="${y}" x2="${x+6}" y2="${y-30}" class="stem" />`;
                if(d.name.includes('#')) html += `<text x="${x-12}" y="${y+5}" font-size="16">â™¯</text>`;
                if(y >= STAFF_TOP_Y+50) html += `<line x1="${x-10}" y1="${STAFF_TOP_Y+50}" x2="${x+10}" y2="${STAFF_TOP_Y+50}" stroke="#000" stroke-width="1" />`;

                if(drawBz) {
                    let ty = bzY + (3-d.string)*20;
                    html += `<rect x="${x-8}" y="${ty-8}" width="16" height="16" fill="white" /><text x="${x}" y="${ty+4}" font-size="14" font-family="sans-serif">${d.fret}</text>`;
                }
                if(drawGtr && d.gtrString!=null) {
                    let ty = gtrY + (5-d.gtrString)*20;
                    html += `<rect x="${x-8}" y="${ty-8}" width="16" height="16" fill="white" /><text x="${x}" y="${ty+4}" font-size="14" font-family="sans-serif">${d.gtrFret}</text>`;
                }
            }
        });
        svg.innerHTML = html;
    }

    // --- PLAYBACK ---
    function togglePlay() {
        if(isPlaying) stopAndReset();
        else {
            if(songData.length===0) return;
            if(playIndex >= songData.length) playIndex=0;
            isPlaying = true;
            document.getElementById('playBtn').innerHTML = 'â¸ ×”×©×”×”';
            document.getElementById('playBtn').classList.replace('btn-green','btn-red');
            playLoop();
        }
    }
    function stopAndReset() {
        clearTimeout(playTimeout); isPlaying=false; playIndex=0;
        document.getElementById('playBtn').innerHTML = 'â–¶ × ×’×Ÿ';
        document.getElementById('playBtn').classList.replace('btn-red','btn-green');
        document.getElementById('playCursor').style.display='none';
        clearBoardHighlights();
    }
    function playLoop() {
        if(!isPlaying) return;
        if(playIndex >= songData.length) { stopAndReset(); return; }
        
        let bpm = document.getElementById('bpmSlider').value;
        let beatTime = 60000/bpm;
        let d = songData[playIndex];
        
        let cursor = document.getElementById('playCursor');
        cursor.style.display='block'; cursor.style.height=document.getElementById('notationPanel').clientHeight+'px';
        cursor.style.left = (START_X + playIndex*NOTE_SPACING)+'px';
        
        let w = document.getElementById('sheetWrapper');
        if((START_X+playIndex*NOTE_SPACING) > (w.scrollLeft+w.clientWidth-100)) w.scrollLeft+=NOTE_SPACING;

        if(d.type==='note') {
            playSoundEnhanced(d.midi, beatTime/1000 * 0.9, 'bouzouki');
            highlightInstruments(d.midi, beatTime*0.9);
            // Flash on Bouzouki neck
            let m = document.getElementById(`bz-${d.string}-${d.fret}`);
            if(m) { m.classList.remove('hidden-marker'); m.classList.add('play-active'); }
        }
        playIndex++;
        playTimeout = setTimeout(playLoop, beatTime);
    }

    // --- VOICE RECOGNITION (××”×§×•×‘×¥ ×”×—×“×©) ---
    let voiceActive = false;
    let audioCtx, analyzer, mic, scriptProc;

    async function toggleVoiceRecognition() {
        if(voiceActive) {
            voiceActive = false;
            if(scriptProc) scriptProc.disconnect();
            if(mic) mic.disconnect();
            document.getElementById('voiceVisualizer').classList.remove('active');
            document.getElementById('voiceBtn').classList.remove('btn-active');
            document.getElementById('voiceBtn').innerText = "ğŸ¤ ×–×™×”×•×™ ×§×•×œ×™";
        } else {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyzer = audioCtx.createAnalyser();
                mic = audioCtx.createMediaStreamSource(stream);
                scriptProc = audioCtx.createScriptProcessor(4096, 1, 1);
                
                mic.connect(analyzer);
                analyzer.connect(scriptProc);
                scriptProc.connect(audioCtx.destination);
                
                scriptProc.onaudioprocess = processVoice;
                
                voiceActive = true;
                document.getElementById('voiceVisualizer').classList.add('active');
                document.getElementById('voiceBtn').classList.add('btn-active');
                document.getElementById('voiceBtn').innerText = "ğŸ¤ ××§×©×™×‘...";
            } catch(e) { alert("×œ× × ×™×ª×Ÿ ×œ×’×©×ª ×œ××™×§×¨×•×¤×•×Ÿ"); }
        }
    }

    function processVoice(e) {
        const buffer = e.inputBuffer.getChannelData(0);
        const freq = autoCorrelate(buffer, audioCtx.sampleRate);
        if(freq > -1) {
            let note = freqToNote(freq);
            document.getElementById('detectedNote').innerText = note.name;
            // Debounce logic for adding note could go here
        }
    }

    function autoCorrelate(buf, sampleRate) {
        let size = buf.length;
        let rms = 0;
        for(let i=0;i<size;i++) { let val = buf[i]; rms += val*val; }
        rms = Math.sqrt(rms/size);
        if(rms < 0.01) return -1; // Too quiet

        let best_offset = -1, best_corr = 0, foundGoodCorr = false;
        let correlations = new Array(size).fill(0);

        for(let offset=0; offset<size; offset++) {
            for(let i=0; i<size-offset; i++) correlations[offset] += buf[i] * buf[i+offset];
            let corr = correlations[offset]/size;
            if(corr > 0.9 && corr > best_corr) { foundGoodCorr = true; if(corr > best_corr) { best_corr = corr; best_offset = offset; } }
            else if(foundGoodCorr) {
                let shift = (correlations[best_offset+1] - correlations[best_offset-1])/correlations[best_offset];  
                return sampleRate/(best_offset+(8*shift));
            }
        }
        if(best_corr > 0.01) return sampleRate/best_offset;
        return -1;
    }

    function freqToNote(freq) {
        let noteNum = 12 * (Math.log(freq / 440) / Math.log(2));
        let midi = Math.round(noteNum) + 69;
        return { name: NOTES[midi%12], midi };
    }

    // --- UTILS ---
    function highlightInstruments(midi, dur) {
        document.querySelectorAll(`[id^='gtr-${midi}']`).forEach(el => { el.classList.add('gtr-active'); setTimeout(()=>el.classList.remove('gtr-active'), dur); });
        let pno = document.getElementById('pno-'+midi); if(pno) { pno.classList.add('piano-active'); setTimeout(()=>pno.classList.remove('piano-active'), dur); }
    }
    function clearBoardHighlights() { document.querySelectorAll('.play-active, .gtr-active, .piano-active').forEach(e=>e.classList.remove('play-active','gtr-active','piano-active')); }
    function scrollToEnd() { setTimeout(() => { let w = document.getElementById('sheetWrapper'); w.scrollLeft = w.scrollWidth; }, 50); }
    function parseAndAdd() { /* Same parse logic as before */ }
    function saveSong() { 
        if(songData.length===0) return alert('×¨×™×§!');
        let blob = new Blob([JSON.stringify(songData)], {type: "application/json"});
        let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'song.json'; a.click();
    }
    function loadSong(input) {
        let file = input.files[0]; if(!file) return;
        let reader = new FileReader(); reader.onload = (e) => { songData = JSON.parse(e.target.result); renderSheet(); };
        reader.readAsText(file);
    }
    function exportMIDI() { alert("MIDI Export logic goes here"); }
</script>
</body>
</html>
