<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1000, initial-scale=1">
    <title>Boaz Composer V45 - Print Fixed</title>
    <style>
        body { background:#121212; color:#eee; font-family:'Segoe UI',sans-serif; margin:0; padding:10px; display:flex; flex-direction:column; align-items:center; }
        * { box-sizing:border-box; user-select:none; }

        h1 { margin: 5px 0; color: #ffb300; text-transform: uppercase; letter-spacing: 2px; font-size: 18px; }
        
        /* --- Toolbar --- */
        .toolbar {
            width: 960px; background: #1e1e1e; padding: 10px; border-radius: 8px; border: 1px solid #444;
            display: flex; gap: 10px; align-items: center; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); flex-wrap: wrap;
        }
        
        input[type="text"] { flex: 1; background: #333; border: 1px solid #555; color: white; padding: 5px 10px; font-size: 16px; border-radius: 4px; direction: ltr; }
        select { background: #333; color: #ffb300; border: 1px solid #555; padding: 5px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        button { background: #37474f; color: white; border: 1px solid #546e7a; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; font-size: 13px; }
        button:hover { background: #455a64; }
        
        .btn-green { background: #2e7d32; border-color: #4caf50; }
        .btn-red { background: #c62828; border-color: #ef5350; }
        .btn-orange { background: #e65100; border-color: #ff9800; }
        .btn-gold { background: #ffb300; color: black; border-color: #ffd54f; }
        .btn-white { background: #e0e0e0; color: black; border-color: #fff; }

        .pick-toggle { width: 40px; font-size: 18px; text-align: center; background: #ffb300; color: black; border: none; }
        .bpm-control { display: flex; align-items: center; gap: 5px; font-size: 12px; color: #aaa; background: #222; padding: 5px 10px; border-radius: 4px; border: 1px solid #444; }
        input[type=range] { width: 100px; height: 5px; }

        /* --- Notation Area --- */
        .sheet-wrapper { width: 960px; overflow-x: auto; background: #fff; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 0 20px rgba(255,255,255,0.1); border: 4px solid #333; position: relative; }
        
        .notation-panel { 
            min-width: 960px; position: relative; 
            /* ×”×¡×¨×ª×™ ×’×•×‘×” ×§×‘×•×¢ ×‘-CSS ×›×“×™ ×©×”-SVG ×™×©×œ×•×˜ */
        }
        
        svg { display: block; } /* ×”×•×¡×¨ width/height 100% ×›×“×™ ×œ×× ×•×¢ ××ª×™×—×” ×œ× × ×›×•× ×” ×‘×”×“×¤×¡×” */
        
        .staff-line { stroke: #444; stroke-width: 1; }
        .tab-line { stroke: #666; stroke-width: 1; }
        text { font-family: serif; fill: #000; text-anchor: middle; font-weight: bold; cursor: default; }
        .note-head { fill: #000; stroke: #000; cursor: pointer; transition: fill 0.2s; }
        .note-head:hover { fill: #2196f3; stroke: #2196f3; }
        
        .stem { stroke: #000; stroke-width: 2; pointer-events: none; }
        .pick-sign { font-size: 20px; font-weight: bold; cursor: pointer; }
        .pick-sign:hover { fill: #d32f2f; }
        
        .section-lbl { font-size: 14px; fill: #d32f2f; font-family: sans-serif; text-anchor: start; font-weight: bold; }

        #playCursor { position: absolute; top: 0; bottom: 0; width: 2px; background: rgba(255, 0, 0, 0.5); pointer-events: none; display: none; z-index: 100; transition: left 0.1s linear; }

        /* --- Instruments --- */
        .inst-label { width: 960px; text-align: right; color: #ffb300; font-size: 12px; margin-bottom: 2px; font-weight: bold; border-bottom: 1px solid #333; margin-top: 5px;}
        .instrument { position: relative; width: 960px; margin-bottom: 5px; background: #0a0a0a; border: 2px solid #333; border-radius: 6px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: height 0.3s, opacity 0.3s; }
        
        .hidden-inst { height: 0; margin: 0; border: none; opacity: 0; pointer-events: none; }
        .hidden-lbl { display: none; }

        .bouzouki-neck { height: 140px; display: flex; position: relative; background: #1a1005; cursor: pointer; }
        .bouzouki-neck .string { position: absolute; left: 0; right: 0; height: 2px; background: #999; box-shadow: 0 1px 2px black; }
        .bouzouki-neck .fret { position: absolute; top: 0; bottom: 0; width: 2px; background: #666; }
        
        .guitar-neck { height: 160px; display: flex; position: relative; background: #2d1a10; cursor: pointer; opacity: 0.95; }
        .guitar-neck .string { position: absolute; left: 0; right: 0; height: 1px; background: #bcaaa4; }
        .guitar-neck .fret { position: absolute; top: 0; bottom: 0; width: 2px; background: #8d6e63; }

        .piano-keys { height: 100px; display: flex; position: relative; background: #000; cursor: pointer; opacity: 0.9; }
        .p-key-white { flex: 1; background: #fff; border: 1px solid #999; border-radius: 0 0 3px 3px; position: relative; }
        .p-key-black { width: 60%; height: 60%; background: #000; position: absolute; top: 0; left: -30%; z-index: 10; border-radius: 0 0 3px 3px; }

        /* Markers */
        .marker { position: absolute; width: 22px; height: 22px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 11px; font-weight: bold; transform: translate(-50%, -50%); z-index: 10; background: #222; border: 1px solid #444; color: #888; }
        
        .bz-marker { background: #333; color: white; border: 1px solid #666; opacity: 1; }
        .bz-marker:hover { background: #ffb300; color: black; z-index: 60; transform: translate(-50%, -50%) scale(1.3); }
        .gtr-marker { background: #1a1005; color: #777; border: none; opacity: 0.8; font-size: 10px; }

        @keyframes pop { 0% { transform: translate(-50%, -50%) scale(1.4); background: #ffb300; color: black; box-shadow: 0 0 15px #ffb300; border-color: white; } 100% { transform: translate(-50%, -50%) scale(1); background: #333; color: white; box-shadow: none; border-color: #555; } }

        .play-active { animation: pop 0.3s ease-out forwards; }
        .gtr-active { background: #4caf50 !important; color: white !important; opacity: 1 !important; z-index: 50; box-shadow: 0 0 10px #4caf50; border: 1px solid white; transform: translate(-50%, -50%) scale(1.2); }
        .piano-active { display: flex !important; background: #2196f3 !important; opacity: 1 !important; box-shadow: 0 0 10px #2196f3; }
        .hidden-marker { display: none; }
        .click-zone { position: absolute; width: 4.8%; height: 25%; z-index: 20; cursor: pointer; }
        .click-zone:hover { background: rgba(255, 255, 255, 0.1); }
        #fileInput { display: none; }

        /* --- PRINT Styles --- */
        @media print {
            body { background: white; padding: 0; }
            h1, .toolbar, .inst-label, .instrument, #playCursor { display: none !important; }
            /* ×”×¡×¨×ª ××¡×’×¨×•×ª ×•×¨×§×¢×™× ××™×•×ª×¨×™× */
            .sheet-wrapper { 
                box-shadow: none; border: none; 
                width: 100%; margin: 0; padding: 0; 
                overflow: visible; position: absolute; top: 0; left: 0; 
            }
            .notation-panel { 
                width: 100% !important; border: none; 
            }
            /* ×•×™×“×•× ×©×”-SVG × ×¤×¨×¡ ×‘××œ×•××• */
            svg { width: 100%; height: auto; }
            @page { size: landscape; margin: 1cm; }
        }
    </style>
</head>
<body>

    <h1>Boaz Studio: Composer V45</h1>

    <div class="toolbar">
        <input type="text" id="txtInput" placeholder='Do Re Mi...'>
        <button onclick="parseAndAdd()">×”×•×¡×£</button>
        <div style="border-left: 1px solid #555; height: 30px; margin: 0 10px;"></div>
        
        <label style="font-size:12px; color:#aaa;">×›×œ×™:</label>
        <select id="focusSelect" onchange="changeFocus()">
            <option value="all">×”×›×œ</option>
            <option value="bouzouki">×‘×•×–×•×§×™</option>
            <option value="guitar">×’×™×˜×¨×”</option>
            <option value="piano">×¤×¡× ×ª×¨</option>
        </select>

        <button class="pick-toggle" id="pickDirBtn" onclick="togglePickDir()">Î </button>
        <button class="btn-blue" onclick="addRest()">×”×¤×¡×§×”</button>
        <button class="btn-orange" onclick="undoLast()">âŒ«</button>
        
        <div style="border-left: 1px solid #555; height: 30px; margin: 0 10px;"></div>
        
        <div class="bpm-control">
            <span>BPM: <span id="bpmVal">120</span></span>
            <input type="range" id="bpmSlider" min="40" max="240" value="120" oninput="document.getElementById('bpmVal').innerText=this.value">
        </div>

        <button id="playBtn" class="btn-green" onclick="togglePlay()">â–¶ × ×’×Ÿ</button>
        <button class="btn-red" onclick="stopAndReset()">â– </button>
        
        <div style="flex:1"></div>
        
        <label style="font-size:12px; color:#aaa;">×ª×¦×•×’×”:</label>
        <select id="scoreLayout" onchange="renderSheet()">
            <option value="all">×”×›×œ (×‘×•×–×•×§×™+×’×™×˜×¨×”)</option>
            <option value="bz">×‘×•×–×•×§×™ + ×—××©×”</option>
            <option value="gtr">×’×™×˜×¨×” + ×—××©×”</option>
        </select>

        <button class="btn-white" onclick="window.print()">ğŸ–¨ PDF</button>
        <button class="btn-gold" onclick="saveSong()">ğŸ’¾</button>
        <button class="btn-blue" onclick="document.getElementById('fileInput').click()">ğŸ“‚</button>
        <input type="file" id="fileInput" accept=".json" onchange="loadSong(this)">
    </div>

    <div class="sheet-wrapper" id="sheetWrapper">
        <div class="notation-panel" id="notationPanel">
            <div id="playCursor"></div>
            <svg id="mainSvg"></svg>
        </div>
    </div>

    <div id="lbl-bz" class="inst-label">×‘×•×–×•×§×™</div>
    <div id="inst-bz" class="instrument bouzouki-neck" id="bouzoukiBoard"></div>

    <div id="lbl-gtr" class="inst-label">×’×™×˜×¨×”</div>
    <div id="inst-gtr" class="instrument guitar-neck" id="guitarBoard"></div>

    <div id="lbl-pno" class="inst-label">×¤×¡× ×ª×¨</div>
    <div id="inst-pno" class="instrument piano-keys" id="pianoBoard"></div>

<script>
    const NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const AUDIO = new (window.AudioContext || window.webkitAudioContext)();
    const NOTE_MAP = {'do':0,'re':2,'mi':4,'fa':5,'sol':7,'la':9,'si':11,'c':0,'d':2,'e':4,'f':5,'g':7,'a':9,'b':11};
    const BZ_STRINGS = [48, 53, 57, 62]; const GTR_STRINGS = [40, 45, 50, 55, 59, 64]; const PIANO_START = 36; 

    let songData = []; let currentPick = 'down'; let isPlaying = false; let playIndex = 0; let playTimeout = null;
    const NOTE_SPACING = 45; const START_X = 80; const STAFF_TOP_Y = 100; 

    window.onload = () => {
        buildBouzouki(); buildGuitar(); buildPiano(); renderSheet();
        document.getElementById('txtInput').addEventListener("keyup", (e) => { if (e.key === "Enter") parseAndAdd(); });
        document.addEventListener("keydown", (e) => { 
            if (e.key === "Backspace" && document.activeElement.tagName !== "INPUT") undoLast(); 
            if (e.code === "Space" && document.activeElement.tagName !== "INPUT") { e.preventDefault(); togglePlay(); }
        });
    };

    function changeFocus() {
        let mode = document.getElementById('focusSelect').value;
        const els = [
            { id: 'inst-bz', l: 'lbl-bz', k: 'bouzouki' },
            { id: 'inst-gtr', l: 'lbl-gtr', k: 'guitar' },
            { id: 'inst-pno', l: 'lbl-pno', k: 'piano' }
        ];
        els.forEach(o => {
            let el = document.getElementById(o.id); let lbl = document.getElementById(o.l);
            if(mode === 'all' || mode === o.k) {
                el.classList.remove('hidden-inst'); lbl.classList.remove('hidden-lbl');
            } else {
                el.classList.add('hidden-inst'); lbl.classList.add('hidden-lbl');
            }
        });
    }

    function buildBouzouki() {
        const board = document.getElementById('inst-bz');
        for(let f=0; f<=20; f++) {
            let div = document.createElement('div'); div.className='fret'; div.style.left=(f*4.8)+'%'; board.appendChild(div);
            if([3,5,7,9,12,15,17,19].includes(f)){
                let num = document.createElement('div'); num.innerText = f; num.style.position='absolute'; num.style.bottom='2px'; num.style.left=(f*4.8+2.4)+'%'; num.style.color='#888'; num.style.fontSize='10px'; num.style.transform='translateX(-50%)'; board.appendChild(num);
            }
        }
        for(let s=0; s<4; s++) { 
            let str = document.createElement('div'); str.className='string'; str.style.top=(20+s*20)+'%'; board.appendChild(str);
            for(let f=0; f<=20; f++) {
                let realStrIdx = 3 - s; let noteVal = BZ_STRINGS[realStrIdx] + f; let noteName = NOTES[noteVal % 12];
                let btn = document.createElement('div'); btn.className = 'marker bz-marker'; btn.id = `bz-${realStrIdx}-${f}`; btn.innerText = noteName; btn.style.left = (f*4.8+2.4)+'%'; btn.style.top = (20+s*20)+'%'; board.appendChild(btn);
                let zone = document.createElement('div'); zone.className = 'click-zone'; zone.style.left = (f*4.8)+'%'; zone.style.top = (s*25)+'%';
                zone.onclick = (e) => { e.stopPropagation(); addNote(noteVal, realStrIdx, f); };
                board.appendChild(zone);
            }
        }
    }

    function buildGuitar() {
        const board = document.getElementById('inst-gtr');
        for(let f=0; f<=20; f++) { let d=document.createElement('div'); d.className='fret'; d.style.left=(f*4.8)+'%'; board.appendChild(d); }
        for(let s=0; s<6; s++) {
            let str=document.createElement('div'); str.className='string'; str.style.top=(10+s*15)+'%'; board.appendChild(str);
            for(let f=0; f<=20; f++) {
                let noteVal = GTR_STRINGS[5-s] + f; let mk = document.createElement('div'); mk.className = 'marker gtr-marker'; mk.id = 'gtr-' + noteVal; mk.innerText = NOTES[noteVal % 12]; mk.style.left = (f * 4.8 + 2.4) + '%'; mk.style.top = (10 + s * 15) + '%';
                mk.style.cursor = 'pointer'; mk.onclick = (e) => { e.stopPropagation(); addNoteFromExternal(noteVal); };
                board.appendChild(mk);
            }
        }
    }

    function buildPiano() {
        const board = document.getElementById('inst-pno');
        for(let i=0; i<40; i++) {
            let noteVal = PIANO_START + i; let noteIdx = noteVal % 12; let isBlack = [1,3,6,8,10].includes(noteIdx);
            if(!isBlack) {
                let key = document.createElement('div'); key.className='p-key-white';
                let nextIsBlack = [1,3,6,8,10].includes((noteVal+1)%12);
                if(nextIsBlack) {
                    let bKey = document.createElement('div'); bKey.className='p-key-black';
                    let mk = document.createElement('div'); mk.className='marker hidden-marker'; mk.id = 'pno-' + (noteVal+1); bKey.appendChild(mk); key.appendChild(bKey); i++;
                    bKey.onmousedown = (e) => { e.stopPropagation(); addNoteFromExternal(noteVal+1); };
                }
                let mk = document.createElement('div'); mk.className='marker hidden-marker'; mk.id = 'pno-' + noteVal; key.appendChild(mk); board.appendChild(key);
                key.onmousedown = (e) => { if(e.target===key || e.target===mk) { e.stopPropagation(); addNoteFromExternal(noteVal); } };
            }
        }
    }

    function calcGuitarPos(midi) {
        for(let s=0; s<6; s++) { let openStr = GTR_STRINGS[s]; let fret = midi - openStr; if(fret >= 0 && fret <= 15) return { s: s, f: fret }; } return null;
    }
    function addNoteFromExternal(midi) { let bestPos = findBestPosition(midi % 12, midi); if(bestPos) addNote(bestPos.midi, bestPos.string, bestPos.fret); else addNote(midi, 3, 0); }
    function togglePickDir() { currentPick = (currentPick === 'down') ? 'up' : 'down'; document.getElementById('pickDirBtn').innerText = (currentPick === 'down') ? 'Î ' : 'V'; }

    function addNote(midi, stringIdx, fret) {
        clearBoardHighlights(); 
        let gtrPos = calcGuitarPos(midi);
        let noteObj = { type: 'note', midi: midi, name: NOTES[midi % 12], string: stringIdx, fret: fret, gtrString: gtrPos ? gtrPos.s : null, gtrFret: gtrPos ? gtrPos.f : null, pick: currentPick };
        songData.push(noteObj); togglePickDir(); playSound(midi, 0.3); highlightInstruments(midi, 200); 
        let bz = document.getElementById(`bz-${stringIdx}-${fret}`);
        if(bz) { bz.classList.remove('play-active'); void bz.offsetWidth; bz.classList.add('play-active'); setTimeout(() => bz.classList.remove('play-active'), 300); }
        renderSheet(); scrollToEnd();
    }

    function addRest() { songData.push({ type: 'rest' }); renderSheet(); scrollToEnd(); }
    function undoLast() { if(songData.length>0) { songData.pop(); renderSheet(); } }
    function clearSong() { songData = []; playIndex=0; stopAndReset(); renderSheet(); }

    function saveSong() {
        if(songData.length === 0) return alert("×¨×™×§!");
        let name = prompt("×©× ×”×©×™×¨:", "MySong"); if(!name) return;
        let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(songData));
        let dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", name + ".json"); dl.click();
    }
    function loadSong(input) {
        let file = input.files[0]; if(!file) return;
        let reader = new FileReader(); reader.onload = function(e) { try { songData = JSON.parse(e.target.result); renderSheet(); alert("× ×˜×¢×Ÿ!"); } catch(err) { alert("×©×’×™××”"); } }; reader.readAsText(file);
    }

    function togglePlay() {
        if(isPlaying) { clearTimeout(playTimeout); isPlaying = false; document.getElementById('playBtn').innerText = "â–¶ ×”××©×š"; document.getElementById('playBtn').classList.replace('btn-red','btn-green'); } 
        else { if(songData.length === 0) return; if(playIndex >= songData.length) playIndex = 0; isPlaying = true; document.getElementById('playBtn').innerText = "â¸"; document.getElementById('playBtn').classList.replace('btn-green','btn-red'); playLoop(); }
    }
    function stopAndReset() { clearTimeout(playTimeout); isPlaying = false; playIndex = 0; document.getElementById('playBtn').innerText = "â–¶ × ×’×Ÿ"; document.getElementById('playBtn').classList.replace('btn-red','btn-green'); document.getElementById('playCursor').style.display = 'none'; clearBoardHighlights(); }

    function playLoop() {
        if(!isPlaying) return; if(playIndex >= songData.length) { stopAndReset(); return; }
        let bpm = document.getElementById('bpmSlider').value; let beatTime = 60000 / bpm; let d = songData[playIndex];
        let cursor = document.getElementById('playCursor'); cursor.style.display = 'block'; cursor.style.height=document.getElementById('notationPanel').clientHeight + 'px'; 
        cursor.style.left = (START_X + playIndex * NOTE_SPACING) + 'px';
        let wrap = document.getElementById('sheetWrapper'); if((START_X + playIndex * NOTE_SPACING) > (wrap.scrollLeft + wrap.clientWidth - 100)) wrap.scrollLeft += NOTE_SPACING;
        if(d.type === 'note') {
            let duration = beatTime * 0.9; playSound(d.midi, duration/1000); highlightInstruments(d.midi, duration);
            let bz = document.getElementById(`bz-${d.string}-${d.fret}`); if(bz) { bz.classList.remove('play-active'); void bz.offsetWidth; bz.classList.add('play-active'); }
        }
        playIndex++; playTimeout = setTimeout(playLoop, beatTime);
    }

    function parseAndAdd() {
        let txt = document.getElementById('txtInput').value.toLowerCase().trim(); if(!txt) return;
        let parts = txt.split(/[\s,]+/);
        parts.forEach(p => {
            if(p === 'r' || p === 'rest') { addRest(); return; }
            let acc = p.includes('#') ? 1 : 0; let base = p.replace('#', '');
            if(NOTE_MAP.hasOwnProperty(base)) { let noteIndex = (NOTE_MAP[base] + acc) % 12; let bestPos = findBestPosition(noteIndex); if(bestPos) addNote(bestPos.midi, bestPos.string, bestPos.fret); }
        });
        document.getElementById('txtInput').value = '';
    }

    function findBestPosition(noteIndex, specificMidi = null) {
        if(specificMidi) { for(let s=3; s>=0; s--) { let base = BZ_STRINGS[s]; let fret = specificMidi - base; if(fret >= 0 && fret <= 20) return { midi: specificMidi, string: s, fret: fret }; } }
        for(let s=3; s>=0; s--) { let base = BZ_STRINGS[s]; for(let f=0; f<=12; f++) { if((base + f) % 12 === noteIndex) return { midi: base+f, string: s, fret: f }; } }
        return null;
    }

    // --- Render Logic (××ª×•×§×Ÿ ×œ×”×“×¤×¡×”) ---
    function renderSheet() {
        let layout = document.getElementById('scoreLayout').value; // all, bz, gtr
        const svg = document.getElementById('mainSvg'); 
        let w = Math.max(960, START_X + songData.length * NOTE_SPACING + 100); 
        
        // ×—×™×©×•×‘ ×’×•×‘×” ×“×™× ××™
        let panelHeight = 220; // ×‘×¡×™×¡ (×—××©×”)
        if(layout === 'all') panelHeight = 440;
        else panelHeight = 320; // ×¨×§ ×—××©×” + ×˜××‘ ××—×“
        
        const panel = document.getElementById('notationPanel');
        panel.style.height = panelHeight + 'px';
        panel.style.width = w + 'px';

        // ×”×ª×™×§×•×Ÿ ×”×§×¨×™×˜×™ ×œ×”×“×¤×¡×”: ×”×’×“×¨×ª viewBox ×•××™×“×•×ª SVG
        svg.setAttribute('viewBox', `0 0 ${w} ${panelHeight}`);
        svg.setAttribute('height', panelHeight);
        svg.setAttribute('width', w);

        let html = '';
        
        // 1. Staff (×ª××™×“ ×‘-100)
        for(let i=0; i<5; i++) { let y = STAFF_TOP_Y + i*10; html += `<line x1="20" y1="${y}" x2="${w-20}" y2="${y}" class="staff-line" />`; }
        html += `<text x="40" y="${STAFF_TOP_Y+35}" style="font-size: 60px;">ğŸ¼</text>`;

        // ××©×ª× ×™× ×œ××™×§×•× ×”×˜××‘×™×
        let drawBz = (layout === 'all' || layout === 'bz');
        let drawGtr = (layout === 'all' || layout === 'gtr');
        
        let bzY = 200; // ×‘×¨×™×¨×ª ××—×“×œ
        let gtrY = (layout === 'all') ? 320 : 200; // ×× ×¨×§ ×’×™×˜×¨×”, ×–×” ×¢×•×œ×” ×œ××¢×œ×”

        if(drawBz) {
            html += `<text x="20" y="${bzY-15}" class="section-lbl">Bouzouki</text>`;
            for(let i=0; i<4; i++) { let y = bzY + i*20; html += `<text x="30" y="${y+5}" font-size="12" fill="#888">${['D','A','F','C'][i]}</text>`; html += `<line x1="50" y1="${y}" x2="${w-20}" y2="${y}" class="tab-line" />`; }
            html += `<line x1="50" y1="${STAFF_TOP_Y}" x2="50" y2="${bzY+60}" stroke="#000" stroke-width="2" />`;
        }

        if(drawGtr) {
            html += `<text x="20" y="${gtrY-15}" class="section-lbl">Guitar</text>`;
            const GTR_NAMES = ['E','B','G','D','A','E'];
            for(let i=0; i<6; i++) { let y = gtrY + i*20; html += `<text x="30" y="${y+5}" font-size="12" fill="#888">${GTR_NAMES[i]}</text>`; html += `<line x1="50" y1="${y}" x2="${w-20}" y2="${y}" class="tab-line" />`; }
            // ×”××¨×›×ª ×”×§×•
            let topConnect = drawBz ? bzY+60 : STAFF_TOP_Y;
            html += `<line x1="50" y1="${topConnect}" x2="50" y2="${gtrY+100}" stroke="#000" stroke-width="2" />`;
        }

        songData.forEach((d, i) => {
            let x = START_X + i * NOTE_SPACING;
            let clickEvt = d.type==='note' ? `onmousedown="showHint(${d.midi})"` : '';

            if(d.type === 'rest') {
                html += `<rect x="${x-6}" y="${STAFF_TOP_Y+15}" width="12" height="10" fill="black" />`;
                if(drawBz) html += `<text x="${x}" y="${bzY+30}" font-size="20" fill="#444">-</text>`;
                if(drawGtr) html += `<text x="${x}" y="${gtrY+50}" font-size="20" fill="#444">-</text>`;
            } else {
                // Staff
                const mapC = {0:0, 1:0, 2:1, 3:1, 4:2, 5:3, 6:3, 7:4, 8:4, 9:5, 10:5, 11:6};
                let octaveDiff = Math.floor(d.midi/12) - 4; let step = mapC[d.midi%12];
                let finalY = (STAFF_TOP_Y + 50) - ((octaveDiff * 7 + step) * 5);
                html += `<ellipse cx="${x}" cy="${finalY}" rx="6" ry="4" class="note-head" ${clickEvt} />`;
                html += `<line x1="${x+6}" y1="${finalY}" x2="${x+6}" y2="${finalY-30}" class="stem" />`;
                if(d.name.includes('#')) html += `<text x="${x-12}" y="${finalY+5}" font-size="16">â™¯</text>`;
                if(finalY >= STAFF_TOP_Y + 50) html += `<line x1="${x-10}" y1="${STAFF_TOP_Y+50}" x2="${x+10}" y2="${STAFF_TOP_Y+50}" stroke="#000" stroke-width="1" />`;

                // Bz Tab
                if(drawBz) {
                    let visualStrIdx = 3 - d.string; let tabY = bzY + visualStrIdx * 20;
                    html += `<rect x="${x-8}" y="${tabY-8}" width="16" height="16" fill="white" />`;
                    html += `<text x="${x}" y="${tabY+4}" font-size="14" font-family="sans-serif">${d.fret}</text>`;
                    let pickSym = (d.pick === 'down') ? 'Î ' : 'V'; let pickColor = (d.pick === 'down') ? 'black' : '#d32f2f';
                    html += `<text x="${x}" y="${bzY-10}" font-size="16" fill="${pickColor}" class="pick-sign" onclick="flipPick(${i})">${pickSym}</text>`;
                }

                // Gtr Tab
                if(drawGtr && d.gtrString !== null) {
                    let gtrVisStr = 5 - d.gtrString; let gtrTabY = gtrY + gtrVisStr * 20;
                    html += `<rect x="${x-8}" y="${gtrTabY-8}" width="16" height="16" fill="white" />`;
                    html += `<text x="${x}" y="${gtrTabY+4}" font-size="14" font-family="sans-serif" fill="#444">${d.gtrFret}</text>`;
                }
            }
        });
        svg.innerHTML = html;
    }

    function showHint(midi) { highlightInstruments(midi, 1000); }
    function scrollToEnd() { setTimeout(() => { let w = document.getElementById('sheetWrapper'); w.scrollLeft = w.scrollWidth; }, 50); }
    function flipPick(index) { if(songData[index].type === 'note') { songData[index].pick = (songData[index].pick === 'down') ? 'up' : 'down'; renderSheet(); } }

    function highlightInstruments(midi, duration) {
        document.querySelectorAll(`[id^='gtr-${midi}']`).forEach(el => { el.classList.add('gtr-active'); setTimeout(()=>el.classList.remove('gtr-active'), duration); });
        let pno = document.getElementById('pno-'+midi); if(pno) { pno.classList.add('piano-active'); setTimeout(()=>pno.classList.remove('piano-active'), duration); }
    }
    function clearBoardHighlights() { document.querySelectorAll('.marker').forEach(e => e.classList.remove('gtr-active', 'piano-active', 'play-active')); }
    function playSound(midi, duration) { const o = AUDIO.createOscillator(); const g = AUDIO.createGain(); o.type = 'triangle'; o.frequency.value = 440 * Math.pow(2, (midi-69)/12); g.gain.setValueAtTime(0.1, AUDIO.currentTime); g.gain.exponentialRampToValueAtTime(0.001, AUDIO.currentTime + duration); o.connect(g); g.connect(AUDIO.destination); o.start(); o.stop(AUDIO.currentTime + duration); }
</script>
</body>
</html>