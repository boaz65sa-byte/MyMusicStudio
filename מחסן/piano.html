<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=1000, initial-scale=1">
<title>Piano Studio V31 - Full Suite</title>
<style>
  body { background:#121212; color:#eee; font-family:'Segoe UI', sans-serif; margin:0; padding:10px; height:100vh; overflow:hidden; display:flex; flex-direction:column; align-items:center; }
  * { box-sizing:border-box; user-select:none; }

  /* ×××©×§ */
  .top-bar { background:#1e1e1e; padding:10px; border-radius:8px; border:1px solid #333; display:flex; gap:10px; margin-bottom:15px; z-index: 50; }
  select,button,input { background:#333; color:#fff; border:1px solid #555; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:14px; outline:none; }
  .btn-gold { background: linear-gradient(to bottom, #ffb300, #ffa000); color:#000; font-weight:bold; border:none; }
  .btn-act { background:#455a64; border-color:#607d8b; }
  .btn-edit { width:100%; background:#222; border:1px solid #d32f2f; color:#e57373; margin-top:5px; }
  .btn-edit.active { background:#d32f2f; color:white; font-weight:bold; }

  /* ×’×•×£ ×”×¤×¡× ×ª×¨ */
  .inst-wrap { 
      direction:ltr; position:relative; width:964px; height:280px; 
      background: #0a0a0a; border: 4px solid #333; border-top: 8px solid #222; border-radius: 6px; 
      display:flex; flex-direction: column; margin-bottom:15px; flex-shrink:0; 
      padding: 5px 0 10px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
  }
  
  .octave-bar { height: 20px; width: 100%; position: relative; border-bottom: 1px solid #333; margin-bottom: 2px; }
  .oct-lbl { position: absolute; top: 0; font-size: 11px; color: #666; font-weight: bold; transform: translateX(-50%); }

  .keys-container { position:relative; flex:1; background: #000; margin: 0 2px; overflow: hidden; }

  .key { position: absolute; top: 0; border-radius:0 0 4px 4px; cursor:pointer; }

  /* ×œ×‘× ×™× */
  .key-white {
      height: 100%; width: 62px; 
      background: linear-gradient(to bottom, #fff 0%, #f2f2f2 100%);
      border: 1px solid #999; border-bottom: 4px solid #bbb;
      z-index: 1; display:flex; justify-content:center; align-items:flex-end; padding-bottom:10px;
  }
  .key-white.active { background: #ddd; box-shadow: inset 0 -2px 5px rgba(0,0,0,0.2); }

  /* ×©×—×•×¨×™× */
  .key-black {
      height: 60%; width: 38px; 
      background: linear-gradient(to bottom right, #333, #000);
      border: 1px solid #222; border-bottom: 6px solid #000;
      z-index: 100; border-radius: 0 0 3px 3px;
      display:flex; justify-content:center; align-items:flex-end; padding-bottom:8px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.6);
  }
  .key-black.active { 
      background: #111; border-bottom: 6px solid #000; 
      box-shadow: inset 0 0 8px rgba(0,0,0,0.9);
  }

  /* ××¨×§×¨×™× */
  .marker {
      width:20px; height:20px; background:radial-gradient(#66bb6a,#2e7d32); 
      border:2px solid white; border-radius:50%; 
      display:flex; justify-content:center; align-items:center; 
      font-size:10px; font-weight:bold; color:white; pointer-events:none;
      box-shadow:0 2px 4px rgba(0,0,0,0.4);
  }
  .marker.root { background:radial-gradient(#ef5350,#c62828); z-index:20; transform:scale(1.1); }
  .key-black .marker { width: 16px; height: 16px; font-size: 9px; margin-bottom: -2px; }
  
  .chord-dot {
      position:absolute; bottom:40px; width:22px; height:22px; 
      background:rgba(33,150,243,0.9); border:2px solid white; border-radius:50%; 
      display:flex; justify-content:center; align-items:center; 
      font-size:10px; font-weight:bold; color:white; pointer-events:none; z-index:15;
      box-shadow: 0 0 5px #2196f3;
  }
  .key-black .chord-dot { bottom:25px; width:18px; height:18px; font-size: 9px; }

  /* ×¤×× ×œ×™× */
  .workspace { display:flex; gap:15px; width:960px; height:360px; }
  .panel { background:#212121; border:1px solid #333; border-radius:8px; padding:10px; display:flex; flex-direction:column; overflow:hidden; }
  .panel-l { flex:2; } .panel-r { flex:1; min-width:320px; background:#263238; border-color:#455a64; }

  .title { font-size:12px; color:#90a4ae; text-transform:uppercase; margin-bottom:5px; display:flex; justify-content:space-between; border-bottom:1px solid #455a64; padding-bottom:5px; font-weight:bold; }

  .ins-box { background:#000; padding:10px; border-radius:6px; text-align:center; margin-bottom:10px; border:1px solid #546e7a; min-height:140px; display:flex; flex-direction:column; justify-content:center; }
  .ins-name { font-size:26px; font-weight:bold; color:white; margin-bottom:2px; }
  .ins-notes { font-size:14px; color:#b0bec5; letter-spacing:1px; margin-bottom:10px; }
  
  .chord-grid { display:flex; flex-wrap:wrap; gap:4px; overflow-y:auto; flex:1; align-content:flex-start; padding:5px; background:rgba(0,0,0,.2); max-height:120px; }
  .chord-btn { background:#37474f; border:1px solid #546e7a; color:#eceff1; margin:0; font-weight:bold; width:30%; font-size:12px; padding:8px; transition:0.2s; border-radius:4px; }
  .chord-btn:hover { background:#ffb300; color:black; transform:scale(1.02); }

  .timeline { background:#121212; height:50px; border-radius:4px; border:1px solid #333; display:flex; align-items:center; padding:0 5px; gap:4px; overflow-x:auto; margin-bottom:10px; }
  .seq-item { background:#424242; padding:3px 6px; font-size:11px; min-width:45px; text-align:center; border-radius:3px; border:1px solid #616161; cursor:pointer; position:relative; margin-right:5px; }
  .seq-item.active { background:#ffb300; color:black; transform:scale(1.1); border-color:white; }
  .del-note { position:absolute; top:-8px; right:-8px; background:#d32f2f; color:white; width:16px; height:16px; font-size:12px; line-height:14px; border-radius:50%; display:none; z-index:100; font-weight:bold; border:1px solid white; text-align:center; }
  .seq-item:hover .del-note { display:block; }
  .chord-item { background:#455a64; border-color:#78909c; min-width:60px; position:relative; }
  .chord-item.active { background:#29b6f6; color:black; }
  .chord-item:hover .del-note { display:block; }

  /* --- ××›×•× ×ª ×ª×•×¤×™× ×¦×¤×” --- */
  #rhythmPanel {
      display: none;
      position: absolute;
      top: 60px; right: 20px;
      width: 320px;
      background: rgba(25, 25, 25, 0.98);
      border: 2px solid #ffb300;
      border-radius: 8px;
      padding: 10px;
      z-index: 2000;
      box-shadow: 0 15px 40px rgba(0,0,0,0.9);
  }
  .rhythm-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 10px; cursor: move; }
  .rhythm-title { font-weight: bold; color: #ffb300; font-size: 14px; }
  .close-btn { background: none; border: none; color: #fff; font-weight: bold; cursor: pointer; }
  
  .rhythm-controls select, .rhythm-controls input { width: 100%; margin-bottom: 5px; background: #222; }
  .beat-dot { width: 8px; height: 8px; background: #444; border-radius: 50%; display: inline-block; margin: 1px; }
  .beat-dot.active { background: #ffb300; box-shadow: 0 0 5px #ffb300; }
  .beat-dot.strong { width: 10px; height: 10px; }

  /* × ×’×Ÿ MP3 */
  .mp3-zone {
      margin-top: 10px; padding-top: 10px; border-top: 1px dashed #444;
  }
  .file-label {
      display: block; background: #455a64; color: white; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-bottom: 5px; text-align: center;
  }
  .file-label:hover { background: #607d8b; }
  #audioPlayer { width: 100%; height: 25px; margin-top: 5px; }

  #err { display:none; position:fixed; top:0; left:0; width:100%; background:red; color:white; text-align:center; padding:5px; z-index:999; }
</style>
</head>
<body>

    <div id="err"></div>

    <div class="top-bar">
        <div style="display:flex; gap:10px; align-items:center;">
            <label>×©×•×¨×©:</label><select id="rt" onchange="run()"></select>
            <label>×¡×•×œ×:</label><select id="sc" onchange="run()"></select>
        </div>
        <button class="btn-gold" onclick="run()">×˜×¢×Ÿ ×§×œ×™×“×™×</button>
        <button class="btn-act" onclick="clrB()">× ×§×”</button>
        <button class="btn-act" style="border:1px solid #ffb300; color:#ffb300;" onclick="toggleRhythm()">ğŸ¥ ××›×•× ×ª ×ª×•×¤×™×</button>
    </div>

    <div id="rhythmPanel">
        <div class="rhythm-header" id="dragHeader">
            <span class="rhythm-title">Rhythm Master</span>
            <button class="close-btn" onclick="toggleRhythm()">Ã—</button>
        </div>
        <div class="rhythm-controls">
            <select id="rhythmStyle" onchange="changeStyle()">
                <optgroup label="--- ×™×•×•× ×™ (9/8 & 3/4) ---">
                    <option value="zeibekiko">×–×™×™×‘×§×™×§×• (Zeibekiko 9/8)</option>
                    <option value="aptaliko">××¤×˜×œ×™×§×• (Aptaliko 9/8)</option>
                    <option value="karsilamas">×§×¨×¡×™×œ××¡ (Karsilamas 9/8)</option>
                    <option value="kamilieriko">×§××™×œ×™××¨×™×§×• (Kamilieriko 9/8)</option>
                    <option value="tsamiko">×¦×××™×§×• (Tsamiko 3/4)</option>
                </optgroup>
                <optgroup label="--- ×™×•×•× ×™ (2/4 & 4/4) ---">
                    <option value="hasapiko">×—×¡×¤×™×§×• (Hasapiko 4/4)</option>
                    <option value="hasaposirto">×—×¡×¤×•×¡×™×¨×˜×• (Hasaposirto 2/4)</option>
                    <option value="sirto">×¡×™×¨×˜×• (Sirto 2/4)</option>
                    <option value="tsifteteli">×¦×¤×˜×˜×œ×™ (Tsifteteli 4/4)</option>
                    <option value="kalamatianos">×§×œ××˜×™×× ×•×¡ (7/8)</option>
                </optgroup>
                <optgroup label="--- ××–×¨×—×™/×—×¤×œ×” (2/4) ---">
                    <option value="malfuf">××œ×¤×•×£ (Malfuf)</option>
                    <option value="ayoub">××™×•×‘/×–××¨ (Ayoub)</option>
                    <option value="fox">×¤×•×§×¡ (Fox)</option>
                    <option value="karachi">×§×¨××¦'×™ (Karachi)</option>
                    <option value="laf">×œ××£ (Laf)</option>
                </optgroup>
                <optgroup label="--- ××–×¨×—×™ (4/4 & ×›×‘×“) ---">
                    <option value="maksum">××§×¡×•× (Maksum)</option>
                    <option value="baladi">×‘×œ×“×™ (Baladi)</option>
                    <option value="saidi">×¡×¢×™×“×™ (Saidi)</option>
                    <option value="masmoudi">××¡××•×“×™ ×’×“×•×œ (Masmoudi 8/4)</option>
                    <option value="samai">×¡×××¢×™ (Samai 10/8)</option>
                </optgroup>
                <optgroup label="--- ××¢×¨×‘×™ ---">
                    <option value="rock">×¨×•×§ (Rock 4/4)</option>
                    <option value="waltz">×•××œ×¡ (Waltz 3/4)</option>
                    <option value="disco">×“×™×¡×§×• (Disco 4/4)</option>
                    <option value="reggae">×¨×’××™×™ (Reggae 4/4)</option>
                </optgroup>
            </select>
            <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa;">
                <span>BPM: <span id="bpmDisplay">120</span></span>
                <input type="range" id="bpmSlider" min="40" max="220" value="120" style="width:60%" oninput="updateBPM()">
            </div>
            <button id="rhythmPlayBtn" class="btn-gold" style="width:100%; margin-top:5px;" onclick="toggleRhythmPlay()">â–¶ × ×’×Ÿ ××§×¦×‘</button>
            <div id="beatVis" style="margin-top:8px; text-align:center; height:12px; display:flex; justify-content:center; gap:2px;"></div>
            
            <div class="mp3-zone">
                <div style="font-size:11px; color:#888; margin-bottom:3px;">× ×’×Ÿ ×œ×™×•×•×™ (Backing Track)</div>
                <label for="fileUpload" class="file-label">ğŸ“‚ ×˜×¢×Ÿ ×©×™×¨ (MP3/WAV)</label>
                <input type="file" id="fileUpload" style="display:none;" accept="audio/*" onchange="loadAudioFile(this)">
                <div id="fileName" style="font-size:10px; color:#ffca28; margin-bottom:2px; text-align:center;"></div>
                <audio id="audioPlayer" controls></audio>
            </div>
        </div>
    </div>

    <div class="inst-wrap">
        <div id="octaves" class="octave-bar"></div>
        <div id="piano" class="keys-container"></div>
    </div>

    <div class="workspace">
        <div class="panel panel-l">
            <div class="title">
                <span style="color:#ffb300;">× ×’×Ÿ ×•×¢×¨×•×š</span>
                <div style="display:flex; gap:5px;">
                    <button class="btn-gold" onclick="playAll()">â–¶ × ×’×Ÿ</button>
                    <button style="background:#d32f2f; border:none; color:white;" onclick="stop()">â– </button>
                    <button style="background:#546e7a; border:none; color:white;" onclick="clrS()">× ×§×” ×”×›×œ</button>
                </div>
            </div>
            <div style="font-size:11px; color:#888;">×× ×’×™× ×” (Melody)</div>
            <div class="timeline" id="melTrack"></div>
            <div style="font-size:11px; color:#888;">××§×•×¨×“×™× (Harmony)</div>
            <div class="timeline" id="chordTrack"></div>
            <div style="margin-top:auto; padding-top:10px; border-top:1px solid #333; display:flex; gap:5px;">
                <input id="sn" placeholder="×©×..." style="flex:1; background:#333; color:white; border:1px solid #555;">
                <button class="btn-gold" onclick="save()">×©××•×¨</button>
                <select id="sl" style="width:120px;"></select>
                <button class="btn-act" onclick="load()">×˜×¢×Ÿ</button>
                <button style="background:#d32f2f; border:none; color:white;" onclick="del()">X</button>
            </div>
        </div>

        <div class="panel panel-r">
            <div class="title">Inspector</div>
            <div class="ins-box">
                <div id="insName" class="ins-name">---</div>
                <div id="insNotes" class="ins-notes">×‘×—×¨ ××§×•×¨×“</div>
                <div style="display:flex; gap:10px; justify-content:center; align-items:center; margin-bottom:8px;">
                    <button class="btn-act" onclick="mvPos(-1)">â—€</button>
                    <span id="posLabel" style="font-size:11px; color:#ffca28;">Pos</span>
                    <button class="btn-act" onclick="mvPos(1)">â–¶</button>
                </div>
                <button id="btnEdit" class="btn-edit" onclick="toggleEdit()">××¦×‘ ×¢×¨×™×›×”: ×›×‘×•×™</button>
                <div style="display:flex; gap:5px; justify-content:center; margin-top:8px;">
                    <button class="btn-act" style="width:70px;" onclick="mod('inv')">Inversion</button>
                    <button class="btn-act" style="width:70px;" onclick="mod('7')">Add 7</button>
                </div>
            </div>
            <button class="btn-gold" style="width:100%; margin-bottom:5px;" onclick="addIns()">×”×•×¡×£ ×œ× ×’×Ÿ â‡©</button>
            <div id="chordGrid" class="chord-grid"></div>
        </div>
    </div>

    <script>
        window.onerror = function(m) { document.getElementById('err').style.display='block'; document.getElementById('err').innerText="×©×’×™××”: "+m; };

        const N=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        const START_MIDI = 48; // C3
        const KEYS_NUM = 25; 

        const SCL={
         "××•×“×•×¡×™×":{'major':[0,2,4,5,7,9,11],'minor':[0,2,3,5,7,8,10],'harmonic':[0,2,3,5,7,8,11],'dorian':[0,2,3,5,7,9,10],'phrygian':[0,1,3,5,7,8,10],'lydian':[0,2,4,6,7,9,11],'mixolydian':[0,2,4,5,7,9,10]},
         "×¢×¨×‘×™":{'bayati':[0,1,3,5,7,8,10],'saba':[0,1,3,4,6,8,10],'nahawand':[0,2,3,5,7,8,11],'ajam':[0,2,4,5,7,9,11],'siga':[0,3,4,7,8,10],'kard':[0,1,3,5,7,8,10],'mahur':[0,2,4,5,7,9,11]},
         "×™×•×•× ×™":{'hitzaz':[0,1,4,5,7,8,10],'hitzazkiar':[0,1,4,5,7,8,11],'piraiotikos':[0,1,4,6,7,8,11],'niavent':[0,2,3,5,7,8,10],'oussak':[0,1,3,5,7,8,10],'kourdi':[0,1,3,5,7,8,10],'sabah':[0,1,3,4,7,8,10],'rast':[0,2,4,5,7,9,11],'houzam':[0,3,4,7,8,11],'segah':[0,3,4,7,8,10],'tabani':[0,2,4,5,7,9,11]}
        };

        let ctx, oscs=[], mel=[], ch=[], isPlay=false, actCh=null, pos=[], pIdx=0, isEdit=false;
        let keysMap = {}; 

        window.onload = () => {
            const r=document.getElementById('rt'); N.forEach((n,i)=>{let o=document.createElement('option');o.value=i;o.text=n;if(n==='C')o.selected=true;r.appendChild(o)});
            const s=document.getElementById('sc');
            for(let g in SCL){let gr=document.createElement('optgroup');gr.label=g;for(let k in SCL[g]){let o=document.createElement('option');o.value=g+'|'+k;o.text=k;gr.appendChild(o)}s.appendChild(gr)}
            buildPiano(); setTimeout(run, 100); ls(); makeDraggable(document.getElementById('rhythmPanel'));
        };

        function buildPiano() {
            const con = document.getElementById('piano');
            const octCon = document.getElementById('octaves');
            con.innerHTML = ''; octCon.innerHTML = ''; keysMap = {};
            let whiteCounter = 0; const W_WIDTH = 64; 
            
            for(let i=0; i<KEYS_NUM; i++) {
                let midi = START_MIDI + i;
                let noteIdx = midi % 12;
                let isBlack = [1,3,6,8,10].includes(noteIdx);
                
                if(noteIdx === 0) {
                    let octLbl = document.createElement('div');
                    octLbl.className = 'oct-lbl';
                    octLbl.innerText = 'C' + (Math.floor(midi / 12) - 1);
                    octLbl.style.left = (whiteCounter * W_WIDTH + 30) + 'px'; 
                    octCon.appendChild(octLbl);
                }

                let k = document.createElement('div');
                k.id = 'k-'+midi;
                k.dataset.midi = midi;
                k.dataset.n = noteIdx;
                
                if (isBlack) {
                    k.className = 'key key-black';
                    k.style.left = ((whiteCounter * W_WIDTH) - 19) + 'px'; 
                } else {
                    k.className = 'key key-white';
                    k.style.left = (whiteCounter * W_WIDTH) + 'px';
                    whiteCounter++;
                }
                con.appendChild(k);
                keysMap[midi] = k;
                k.onmousedown = (e) => {
                    e.stopPropagation();
                    if(isEdit && actCh) toggleNoteInChord(noteIdx);
                    else { playNote(midi); mel.push({n:N[noteIdx], m:midi}); rend(); }
                };
            }
        }

        function playNote(midi) {
            let fr = 440 * Math.pow(2, (midi - 69) / 12);
            play(fr);
            let k = keysMap[midi];
            if(k) { k.classList.add('active'); setTimeout(() => k.classList.remove('active'), 150); }
        }

        function run(){
            clrB(); actCh=null; pos=[]; pIdx=0; updIns(); isEdit=false; updEditBtn();
            let rt=parseInt(document.getElementById('rt').value);
            let v=document.getElementById('sc').value.split('|'), ints=SCL[v[0]][v[1]];
            let nts=ints.map(x=>(rt+x)%12);
            
            for(let m in keysMap) {
                let k = keysMap[m];
                let n = parseInt(k.dataset.n);
                if(nts.includes(n)) {
                    let mk = document.createElement('div');
                    mk.className = 'marker ' + (n===rt ? 'root' : '');
                    mk.innerText = N[n];
                    k.appendChild(mk);
                }
            }
            mkCh(rt, ints);
        }

        function mkCh(rt,ints){
            let g=document.getElementById('chordGrid'); g.innerHTML='';
            for(let i=0;i<ints.length;i++){
                let n1=(rt+ints[i])%12, n3=(rt+ints[(i+2)%ints.length])%12, n5=(rt+ints[(i+4)%ints.length])%12;
                let t=(n3-n1+12)%12===4?'':'m';
                let b=document.createElement('button'); b.className='chord-btn'; b.innerText=N[n1]+t;
                let o={name:N[n1]+t, notes:[n1,n3,n5]};
                b.onclick=()=>{ loadCh(o); }; g.appendChild(b);
            }
        }

        function loadCh(o) { actCh=JSON.parse(JSON.stringify(o)); calcPos(); pIdx=0; updIns(); playPos(); showPos(); }
        function toggleEdit() { if(!actCh) return alert("×‘×—×¨ ××§×•×¨×“"); isEdit = !isEdit; updEditBtn(); }
        function updEditBtn() { let b = document.getElementById('btnEdit'); if(isEdit) { b.classList.add('active'); b.innerText = "×¢×¨×™×›×” ×¤×¢×™×œ×”"; } else { b.classList.remove('active'); b.innerText = "××¦×‘ ×¢×¨×™×›×”: ×›×‘×•×™"; } }
        function toggleNoteInChord(n) { let idx = actCh.notes.indexOf(n); if(idx > -1) actCh.notes.splice(idx, 1); else actCh.notes.push(n); actCh.name = "Custom"; calcPos(); pIdx=0; updIns(); showPos(); play(440); }

        function calcPos(){
            pos=[];
            let chordTones = actCh.notes;
            findInversionSequence(chordTones[0], chordTones); 
            let inv1 = [chordTones[1], chordTones[2], chordTones[0]];
            if(chordTones.length > 2) findInversionSequence(chordTones[1], inv1);
            let inv2 = [chordTones[2], chordTones[0], chordTones[1]];
            if(chordTones.length > 2) findInversionSequence(chordTones[2], inv2);
            
            if(pos.length === 0) {
                let fallback = [];
                for(let i=0; i<KEYS_NUM; i++) {
                    let midi = START_MIDI + i;
                    if(chordTones.includes(midi%12)) fallback.push({m:midi, n:midi%12, fr:440*Math.pow(2,(midi-69)/12)});
                }
                if(fallback.length) pos.push(fallback);
            }
        }

        function findInversionSequence(startNoteIndex, sequencePattern) {
            for(let i=0; i<KEYS_NUM; i++) {
                let midi = START_MIDI + i;
                if(midi % 12 === startNoteIndex) {
                    let potentialChord = [];
                    let currentMidi = midi;
                    let valid = true;
                    for(let j=0; j<sequencePattern.length; j++) {
                        let targetNote = sequencePattern[j];
                        let foundNext = false;
                        let scanStart = (j===0) ? currentMidi : currentMidi + 1;
                        for(let k=scanStart; k < START_MIDI + KEYS_NUM; k++) {
                            if(k % 12 === targetNote) {
                                potentialChord.push({m:k, n:targetNote, fr:440*Math.pow(2,(k-69)/12)});
                                currentMidi = k; foundNext = true; break;
                            }
                        }
                        if(!foundNext) { valid = false; break; }
                    }
                    if(valid && potentialChord.length === sequencePattern.length) pos.push(potentialChord);
                }
            }
        }

        function mvPos(d){ if(!pos.length)return; pIdx=(pIdx+d+pos.length)%pos.length; updIns(); playPos(); showPos(); }
        function updIns(){ if(!actCh){ document.getElementById('insName').innerText="---"; return;} document.getElementById('insName').innerText=actCh.name; document.getElementById('insNotes').innerText=actCh.notes.map(x=>N[x]).join('-'); document.getElementById('posLabel').innerText=(pIdx+1)+"/"+pos.length; }
        function mod(t){ if(!actCh)return; if(t==='inv'){actCh.notes.push(actCh.notes.shift());actCh.name+='/I';} if(t==='7'){let l=actCh.notes[actCh.notes.length-1];actCh.notes.push((l+3)%12);actCh.name+='7';} calcPos(); pIdx=0; updIns(); playPos(); showPos(); }

        function showPos() {
            document.querySelectorAll('.chord-dot').forEach(e=>e.remove());
            if(!pos[pIdx]) return;
            pos[pIdx].forEach(p=>{
                let k = keysMap[p.m];
                if(k) {
                    let d=document.createElement('div'); d.className='chord-dot'; d.innerText=N[p.n];
                    k.appendChild(d);
                }
            });
        }
        function playPos() { if(pos[pIdx]) pos[pIdx].forEach((p,i)=>setTimeout(()=>play(p.fr),i*40)); }
        function addIns(){ if(actCh){ ch.push({name:actCh.name, pts:pos[pIdx]}); rend(); } }
        function clrS(){ mel=[]; ch=[]; rend(); }
        function removeMel(idx) { mel.splice(idx,1); rend(); }
        function removeCh(idx) { ch.splice(idx,1); rend(); }

        function rend() {
            let tm=document.getElementById('melTrack'), tc=document.getElementById('chordTrack');
            tm.innerHTML=''; tc.innerHTML='';
            mel.forEach((x,i)=>{ let d=document.createElement('div'); d.className='seq-item'; d.id='m'+i; d.innerHTML=`${x.n}<div class="del-note" onclick="removeMel(${i})">Ã—</div>`; d.onclick=(e)=>{ if(e.target.className!=='del-note') playNote(x.m); }; tm.appendChild(d); });
            ch.forEach((x,i)=>{ let d=document.createElement('div'); d.className='seq-item chord-item'; d.id='c'+i; d.innerHTML=`${x.name}<div class="del-note" onclick="removeCh(${i})">Ã—</div>`; d.onclick=(e)=>{ if(e.target.className!=='del-note') x.pts.forEach((p,j)=>setTimeout(()=>play(p.fr),j*40)); }; tc.appendChild(d); });
        }

        function playAll(){
            if(isPlay)return; isPlay=true; if(!ctx)ctx=new(window.AudioContext||window.webkitAudioContext)(); ctx.resume();
            let idx=0;
            function loop(){
                if(!isPlay)return;
                document.querySelectorAll('.active').forEach(e=>e.classList.remove('active'));
                if(idx<mel.length){
                    playNote(mel[idx].m);
                    let e=document.getElementById('m'+idx); if(e){e.classList.add('active'); e.scrollIntoView({inline:'center'});}
                    let ci=Math.floor(idx/4);
                    if(idx%4===0 && ci<ch.length){
                        let c=ch[ci]; c.pts.forEach((p,j)=>setTimeout(()=>play(p.fr),j*40));
                        let ce=document.getElementById('c'+ci); if(ce)ce.classList.add('active');
                        document.querySelectorAll('.chord-dot').forEach(e=>e.remove());
                        c.pts.forEach(p=>{
                            let k=keysMap[p.m];
                            if(k){let d=document.createElement('div');d.className='chord-dot';d.innerText=N[p.n];k.appendChild(d)}
                        });
                    }
                    idx++; setTimeout(loop,400);
                } else stop();
            }
            loop();
        }
        function stop(){ isPlay=false; }

        function play(f){
            if(!ctx)ctx=new(window.AudioContext||window.webkitAudioContext)(); ctx.resume();
            let o=ctx.createOscillator(), g=ctx.createGain();
            o.type='triangle'; o.frequency.value=f;
            g.gain.setValueAtTime(0,ctx.currentTime); g.gain.linearRampToValueAtTime(0.2,ctx.currentTime+0.05); g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.4);
            o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.4);
        }
        function clrB(){document.querySelectorAll('.marker,.chord-dot').forEach(e=>e.remove())}
        function save(){ let n=document.getElementById('sn').value; if(n){localStorage.setItem('pno31_'+n,JSON.stringify({m:mel,c:ch})); ls(); alert('× ×©××¨');} }
        function load(){ let n=document.getElementById('sl').value; if(n){let d=JSON.parse(localStorage.getItem(n)); if(d){mel=d.m; ch=d.c; rend();}} }
        function del(){ let n=document.getElementById('sl').value; if(n&&confirm('?')){localStorage.removeItem(n); ls();} }
        function ls(){ let s=document.getElementById('sl'); s.innerHTML=''; for(let i=0;i<localStorage.length;i++){let k=localStorage.key(i); if(k.startsWith('pno31_')){let o=document.createElement('option'); o.value=k; o.text=k.replace('pno31_',''); s.appendChild(o);}}}

        // --- RHYTHM MACHINE LOGIC ---
        let rhythmInterval, isRhythmPlaying = false;
        const RHYTHMS = {
            'zeibekiko': [1,0,0,2,0,1,0,2,0,2,0,0], 'aptaliko': [1,0,0,1,0,0,2,0,0], 'karsilamas': [1,0,2,0,2,0,1,0,0], 'kamilieriko': [1,0,0,2,0,0,1,0,2], 'tsamiko': [1,0,2,0,2,0],
            'hasapiko': [1,0,2,0,1,0,2,0], 'hasaposirto': [1,0,2,0,2,0,1,0], 'sirto': [1,0,2,0,2,0,1,0], 'tsifteteli': [1,0,2,0,2,0,1,0,2,0,0,0], 'kalamatianos': [1,0,2,1,0,2,0],
            'malfuf': [1,0,0,2], 'ayoub': [1,0,0,2], 'fox': [1,0,2,0,1,0,2,0], 'karachi': [2,0,1,0], 'laf': [1,0,2,0],
            'maksum': [1,0,2,0,0,2,1,0,2,0,0,0], 'baladi': [1,0,1,0,0,2,1,0,0,0,2,0], 'saidi': [1,0,2,0,1,1,0,0,2,0,0,0], 'masmoudi': [1,0,1,0,0,0,2,0,1,0,0,0,2,0,0,0], 'samai': [1,0,0,2,0,1,0,2,0,0],
            'rock': [1,0,2,0,1,0,2,0], 'waltz': [1,0,2,0,2,0], 'disco': [1,0,0,0,2,0,0,0], 'reggae': [0,0,2,0,1,0,2,0]
        };

        function toggleRhythm() { let p = document.getElementById('rhythmPanel'); p.style.display = (p.style.display === 'block') ? 'none' : 'block'; }
        function toggleRhythmPlay() { if(isRhythmPlaying) { clearInterval(rhythmInterval); isRhythmPlaying = false; document.getElementById('rhythmPlayBtn').innerText = "â–¶ × ×’×Ÿ ××§×¦×‘"; } else { let bpm = document.getElementById('bpmSlider').value; startRhythm(bpm); isRhythmPlaying = true; document.getElementById('rhythmPlayBtn').innerText = "â–  ×¢×¦×•×¨"; } }
        function updateBPM() { let val = document.getElementById('bpmSlider').value; document.getElementById('bpmDisplay').innerText = val; if(isRhythmPlaying) { clearInterval(rhythmInterval); startRhythm(val); } }
        function startRhythm(bpm) { if(!ctx) ctx=new(window.AudioContext||window.webkitAudioContext)(); ctx.resume(); let pat = RHYTHMS[document.getElementById('rhythmStyle').value] || RHYTHMS['zeibekiko']; updateBeatVis(pat.length); let i = 0; let speed = (60000 / bpm) / 2; if(pat.length < 5) speed = (60000 / bpm); rhythmInterval = setInterval(()=>{ document.querySelectorAll('.beat-dot').forEach((d,ix)=>d.classList.toggle('active', ix===i)); if(pat[i]===1) playDrum(150, 0.01); if(pat[i]===2) playDrum(800, 0.05); i = (i+1)%pat.length; }, speed); }
        function playDrum(freq, len) { let o=ctx.createOscillator(), g=ctx.createGain(); o.frequency.value=freq; g.gain.setValueAtTime(1,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.1); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.1); }
        function updateBeatVis(len) { let d = document.getElementById('beatVis'); d.innerHTML=''; for(let i=0;i<len;i++) { let s=document.createElement('span'); s.className='beat-dot ' + (i===0 ? 'strong':''); d.appendChild(s); } }
        function changeStyle() { if(isRhythmPlaying) { clearInterval(rhythmInterval); startRhythm(document.getElementById('bpmSlider').value); } }
        function loadAudioFile(input) { const file = input.files[0]; if (file) { const url = URL.createObjectURL(file); const player = document.getElementById('audioPlayer'); player.src = url; document.getElementById('fileName').innerText = file.name; } }
        function makeDraggable(el) { let pos1=0, pos2=0, pos3=0, pos4=0; document.getElementById('dragHeader').onmousedown = dragMouseDown; function dragMouseDown(e) { e = e || window.event; e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag; } function elementDrag(e) { e = e || window.event; e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; el.style.top = (el.offsetTop - pos2) + "px"; el.style.left = (el.offsetLeft - pos1) + "px"; } function closeDragElement() { document.onmouseup = null; document.onmousemove = null; } }
    </script>
</body>
</html>