<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boaz Metronome</title>
    <style>
        body { background: #121212; color: #eee; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        
        .metro-box {
            background: #263238; padding: 30px; border-radius: 20px; text-align: center;
            border: 2px solid #455a64; width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .bpm-display { font-size: 80px; font-weight: bold; color: #fff; margin: 10px 0; cursor: pointer; }
        .bpm-label { color: #90a4ae; font-size: 14px; text-transform: uppercase; letter-spacing: 2px; }

        input[type=range] { width: 100%; margin: 20px 0; accent-color: #ffb300; }

        .controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .btn-circle {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid #546e7a;
            background: #37474f; color: white; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-circle:active { background: #ffb300; color: black; }

        .play-btn {
            width: 80px; height: 80px; border-radius: 50%; background: #ffb300; border: none;
            font-size: 30px; color: black; box-shadow: 0 0 20px rgba(255, 179, 0, 0.4);
            cursor: pointer; margin: 0 auto; display: block;
        }
        .play-btn.playing { background: #f44336; box-shadow: 0 0 20px rgba(244, 67, 54, 0.4); color: white; }

        .beat-dots { display: flex; justify-content: center; gap: 8px; margin-top: 20px; height: 15px; }
        .dot { width: 12px; height: 12px; background: #444; border-radius: 50%; transition: 0.1s; }
        .dot.active { background: #ffb300; box-shadow: 0 0 10px #ffb300; transform: scale(1.3); }
        .dot.strong { width: 14px; height: 14px; border: 1px solid #777; }

        select { background: #37474f; color: white; border: none; padding: 5px; border-radius: 4px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="metro-box">
    <div class="bpm-label">קצב (BPM)</div>
    <div class="bpm-display" id="bpmNum">120</div>
    
    <div class="controls">
        <button class="btn-circle" onclick="changeBpm(-5)">-5</button>
        <button class="btn-circle" onclick="changeBpm(-1)">-1</button>
        <button class="btn-circle" onclick="changeBpm(1)">+1</button>
        <button class="btn-circle" onclick="changeBpm(5)">+5</button>
    </div>

    <input type="range" id="bpmSlider" min="40" max="220" value="120" oninput="setBpm(this.value)">

    <select id="timeSig" onchange="updateDots()">
        <option value="4">4/4 (רגיל)</option>
        <option value="3">3/4 (ואלס)</option>
        <option value="2">2/4 (מארש)</option>
        <option value="7">7/8 (יווני - קלמטיאנוס)</option>
        <option value="9">9/8 (יווני - זייבקיקו)</option>
    </select>

    <div class="beat-dots" id="dotsCon"></div>

    <br>
    <button id="playBtn" class="play-btn" onclick="togglePlay()">▶</button>
    <button style="background:none; border:none; color:#888; font-size:12px; margin-top:10px; cursor:pointer;" onclick="tapTempo()">TAP TEMPO</button>
</div>

<script>
    let audioCtx = null;
    let isPlaying = false;
    let timerID = null;
    let bpm = 120;
    let currentBeat = 0;
    let beatsPerBar = 4;
    
    // Tap Tempo vars
    let lastTap = 0;

    window.onload = updateDots;

    function setBpm(val) {
        bpm = val;
        document.getElementById('bpmNum').innerText = bpm;
        document.getElementById('bpmSlider').value = bpm;
        if(isPlaying) { clearInterval(timerID); startTimer(); }
    }

    function changeBpm(delta) {
        setBpm(parseInt(bpm) + delta);
    }

    function updateDots() {
        beatsPerBar = parseInt(document.getElementById('timeSig').value);
        const con = document.getElementById('dotsCon');
        con.innerHTML = '';
        for(let i=0; i<beatsPerBar; i++) {
            let d = document.createElement('div');
            d.className = 'dot ' + (i===0 ? 'strong' : '');
            d.id = 'dot-'+i;
            con.appendChild(d);
        }
    }

    function togglePlay() {
        if(isPlaying) {
            clearInterval(timerID);
            isPlaying = false;
            document.getElementById('playBtn').innerText = "▶";
            document.getElementById('playBtn').classList.remove('playing');
            currentBeat = 0;
            resetDots();
        } else {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            isPlaying = true;
            document.getElementById('playBtn').innerText = "■";
            document.getElementById('playBtn').classList.add('playing');
            startTimer();
        }
    }

    function startTimer() {
        let interval = 60000 / bpm;
        // עבור משקלים מורכבים כמו 7/8, הקצב הוא לשמיניות, אז נאיץ
        if(beatsPerBar > 4) interval = interval / 2; 

        playClick(); // פעימה ראשונה
        timerID = setInterval(playClick, interval);
    }

    function playClick() {
        // Visual
        resetDots();
        let dot = document.getElementById('dot-'+currentBeat);
        if(dot) dot.classList.add('active');

        // Audio
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if(currentBeat === 0) {
            osc.frequency.value = 1200; // צליל גבוה לתחילת תיבה
        } else {
            osc.frequency.value = 800; // צליל נמוך
        }

        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
        osc.stop(audioCtx.currentTime + 0.05);

        currentBeat = (currentBeat + 1) % beatsPerBar;
    }

    function resetDots() {
        document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
    }

    function tapTempo() {
        let now = Date.now();
        if (now - lastTap < 2000) {
            let diff = now - lastTap;
            let newBpm = Math.round(60000 / diff);
            if(newBpm > 30 && newBpm < 300) setBpm(newBpm);
        }
        lastTap = now;
    }
</script>

</body>
</html>