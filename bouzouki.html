<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1000, initial-scale=1">
    <title>Bouzouki Studio V28 - Rhythm Powerhouse</title>
    <style>
        /* --- ×‘×¡×™×¡ --- */
        body { background:#121212; color:#eee; font-family:'Segoe UI',sans-serif; margin:0; padding:10px; height:100vh; overflow:hidden; display:flex; flex-direction:column; align-items:center; }
        * { box-sizing:border-box; user-select:none; }

        /* --- ×›×¤×ª×•×¨×™× --- */
        button, select, input { height:32px; padding:0 10px; border-radius:4px; font-size:13px; border:1px solid #555; background:#333; color:white; outline:none; cursor:pointer; }
        .btn-gold { background:#ffb300; color:black; font-weight:bold; border:none; } .btn-gold:hover{background:#ffca28;}
        .btn-act { background:#455a64; border-color:#607d8b; min-width:35px; } .btn-act:hover{background:#29b6f6; color:black;}
        
        .btn-edit { background:#222; border:2px solid #d32f2f; color:#ef9a9a; width:100%; margin-top:5px; transition:0.3s; font-weight:bold;}
        .btn-edit.active { background:#d32f2f; color:white; box-shadow:0 0 15px #d32f2f; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0%{box-shadow:0 0 0 #d32f2f;} 50%{box-shadow:0 0 10px #d32f2f;} 100%{box-shadow:0 0 0 #d32f2f;} }

        /* --- ×¢×œ×™×•×Ÿ --- */
        .top-bar { background:#1e1e1e; padding:8px 15px; border-radius:8px; border:1px solid #333; display:flex; gap:10px; align-items:center; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,.5); width:980px; justify-content:center; z-index: 50; }
        
        /* --- ×‘×•×–×•×§×™ --- */
        .inst-wrap { direction:ltr; display:flex; align-items:center; height:260px; width:980px; flex-shrink:0; box-shadow:0 20px 60px rgba(0,0,0,.9); border-radius:12px; border:5px solid #4e342e; position:relative; background:#080808; overflow:hidden; transition:transform 0.5s; margin-bottom:15px; }
        .inst-wrap.flip { transform: scaleX(-1); }
        .inst-wrap.flip .flip-fix { transform: scaleX(-1); display:inline-flex; justify-content:center; align-items:center; }

        .head { width:100px; height:100%; background:#1a1005; position:relative; z-index:2; border-right:3px solid #000; }
        .nut { width:16px; height:100%; background:linear-gradient(to right, #ddd, #999); z-index:5; }
        .neck { flex:1; height:100%; background:linear-gradient(to bottom,#3e2723,#150d0b); position:relative; }
        .line { position:absolute; top:0; bottom:0; width:3px; background:#888; border-left:1px solid #aaa; }
        .num { position:absolute; bottom:3px; width:20px; margin-left:-10px; font-size:10px; color:#8d6e63; font-weight:bold; text-align:center; display:flex; justify-content:center; }
        .dot { position:absolute; width:14px; height:14px; background:#eee; border-radius:50%; top:50%; margin:-7px; opacity:0.8; box-shadow:0 0 5px rgba(255,255,255,0.2); } 
        .dot.t{top:25%} .dot.b{top:75%}
        .course { position:relative; width:100%; height:25%; display:flex; flex-direction:column; justify-content:space-evenly; padding: 4px 0; }
        .string { width:100%; box-shadow:0 1px 2px rgba(0,0,0,1); border-radius:2px; }
        .str-gold { background: #ffb300; border-bottom:1px solid #e65100; }
        .str-silver { background: #e0e0e0; border-bottom:1px solid #757575; }
        .h-thick { height:4px; } .h-med { height:3px; } .h-thin { height:2px; }
        .char { position:absolute; left:15px; top:35%; color:#ffb300; font-size:20px; font-weight:bold; font-family:serif; z-index:10; text-shadow:2px 2px 2px black; width: 20px; text-align: center; display:flex; justify-content:center; }
        .marker { position:absolute; width:26px; height:26px; background:radial-gradient(circle,#43a047,#2e7d32); border:2px solid white; border-radius:50%; top:50%; margin:-13px; z-index:20; display:flex; justify-content:center; align-items:center; font-size:11px; font-weight:bold; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.5); }
        .marker.root { background:radial-gradient(circle,#e53935,#b71c1c); z-index:21; }
        .flash { background:#fff!important; box-shadow:0 0 25px #fff; z-index:200; transition:0.1s; }
        .chord-dot { position:absolute; width:28px; height:28px; background:rgba(33,150,243,0.9); border:2px solid #fff; border-radius:50%; top:50%; margin:-14px; z-index:90; pointer-events:none; box-shadow:0 0 15px #2196f3; display:flex; justify-content:center; align-items:center; font-size:11px; color:white; font-weight:bold; }

        /* --- ××–×•×¨ ×¢×‘×•×“×” --- */
        .workspace { display:flex; gap:15px; width:980px; height:360px; }
        .panel { background:#212121; border:1px solid #333; border-radius:8px; padding:10px; display:flex; flex-direction:column; overflow:hidden; }
        .panel-l { flex:2; } .panel-r { flex:1; min-width:320px; background:#263238; border-color:#455a64; }
        .title { font-size:12px; color:#90a4ae; text-transform:uppercase; margin-bottom:5px; display:flex; justify-content:space-between; border-bottom:1px solid #455a64; padding-bottom:5px; font-weight:bold; }
        .ins-box { background:#000; padding:10px; border-radius:6px; text-align:center; margin-bottom:10px; border:1px solid #546e7a; min-height:140px; display:flex; flex-direction:column; justify-content:center; }
        .ins-name { font-size:26px; font-weight:bold; color:white; margin-bottom:2px; }
        .ins-notes { font-size:14px; color:#b0bec5; letter-spacing:1px; margin-bottom:10px; }
        .chord-grid { display:flex; flex-wrap:wrap; gap:4px; overflow-y:auto; flex:1; align-content:flex-start; padding:5px; background:rgba(0,0,0,.2); max-height:120px; }
        .chord-btn { background:#37474f; border:1px solid #546e7a; color:#eceff1; margin:0; font-weight:bold; width:30%; font-size:12px; padding:8px; transition:0.2s; border-radius:4px; }
        .chord-btn:hover { background:#ffb300; color:black; transform:scale(1.02); }
        .timeline { background:#121212; height:50px; border-radius:4px; border:1px solid #333; display:flex; align-items:center; padding:0 5px; gap:4px; overflow-x:auto; margin-bottom:10px; }
        .seq-item { background:#424242; padding:3px 6px; font-size:11px; min-width:45px; text-align:center; border-radius:3px; border:1px solid #616161; cursor:pointer; position:relative; margin-right:5px; }
        .seq-item.active { background:#ffb300; color:black; transform:scale(1.1); border-color:white; }
        .del-note { position:absolute; top:-8px; right:-8px; background:#d32f2f; color:white; width:16px; height:16px; font-size:12px; line-height:14px; border-radius:50%; display:none; z-index:100; font-weight:bold; border:1px solid white; text-align:center; }
        .seq-item:hover .del-note { display:block; }
        .chord-item { background:#455a64; border-color:#78909c; min-width:60px; position:relative; }
        .chord-item.active { background:#29b6f6; color:black; }
        .chord-item:hover .del-note { display:block; }

        /* --- ××›×•× ×ª ×ª×•×¤×™× ××©×•×¤×¨×ª (Floating) --- */
        #rhythmPanel {
            display: none;
            position: absolute;
            top: 60px; right: 20px;
            width: 320px; /* ×¨×—×‘ ×™×•×ª×¨ */
            background: rgba(25, 25, 25, 0.98);
            border: 2px solid #ffb300;
            border-radius: 8px;
            padding: 10px;
            z-index: 2000;
            box-shadow: 0 15px 40px rgba(0,0,0,0.9);
        }
        .rhythm-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 10px; cursor: move; }
        .rhythm-title { font-weight: bold; color: #ffb300; font-size: 14px; }
        .close-btn { background: none; border: none; color: #fff; font-weight: bold; cursor: pointer; }
        
        .rhythm-controls select, .rhythm-controls input { width: 100%; margin-bottom: 5px; background: #222; }
        .beat-dot { width: 8px; height: 8px; background: #444; border-radius: 50%; display: inline-block; margin: 1px; }
        .beat-dot.active { background: #ffb300; box-shadow: 0 0 5px #ffb300; }
        .beat-dot.strong { width: 10px; height: 10px; } /* ×”×“×’×©×” ×©×œ ×”-1 */
        
        /* × ×’×Ÿ MP3 */
        .mp3-zone {
            margin-top: 10px; padding-top: 10px; border-top: 1px dashed #444;
        }
        .file-label {
            display: block; background: #455a64; color: white; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-bottom: 5px; text-align: center;
        }
        .file-label:hover { background: #607d8b; }
        #audioPlayer { width: 100%; height: 30px; margin-top: 5px; }

        #err { display:none; position:fixed; top:0; left:0; width:100%; background:red; color:white; text-align:center; padding:5px; z-index:999; }
    </style>
</head>
<body>

    <div id="err"></div>

    <div class="top-bar">
        <div style="display:flex; gap:10px; align-items:center;">
            <label>×©×•×¨×©:</label><select id="rootSelect" onchange="run()"></select>
            <label>×¡×•×œ×:</label><select id="scaleSelect" onchange="run()"></select>
        </div>
        <button class="btn-gold" onclick="run()">×˜×¢×Ÿ ×’×¨×™×£</button>
        <button class="btn-act" onclick="toggleFlip()">×”×™×¤×•×š ×¦×“</button>
        <button class="btn-act" onclick="clearBoard()">× ×§×” ×’×¨×™×£</button>
        <button class="btn-act" style="border:1px solid #ffb300; color:#ffb300;" onclick="toggleRhythm()">ğŸ¥ ××›×•× ×ª ×ª×•×¤×™×</button>
    </div>

    <div id="rhythmPanel">
        <div class="rhythm-header" id="dragHeader">
            <span class="rhythm-title">Rhythm Master</span>
            <button class="close-btn" onclick="toggleRhythm()">Ã—</button>
        </div>
        <div class="rhythm-controls">
            <select id="rhythmStyle" onchange="changeStyle()">
                <optgroup label="--- ×™×•×•× ×™ (9/8 & 3/4) ---">
                    <option value="zeibekiko">×–×™×™×‘×§×™×§×• (Zeibekiko 9/8)</option>
                    <option value="aptaliko">××¤×˜×œ×™×§×• (Aptaliko 9/8)</option>
                    <option value="karsilamas">×§×¨×¡×™×œ××¡ (Karsilamas 9/8)</option>
                    <option value="kamilieriko">×§××™×œ×™××¨×™×§×• (Kamilieriko 9/8)</option>
                    <option value="tsamiko">×¦×××™×§×• (Tsamiko 3/4)</option>
                </optgroup>
                <optgroup label="--- ×™×•×•× ×™ (2/4 & 4/4) ---">
                    <option value="hasapiko">×—×¡×¤×™×§×• (Hasapiko 4/4)</option>
                    <option value="hasaposirto">×—×¡×¤×•×¡×™×¨×˜×• (Hasaposirto 2/4)</option>
                    <option value="sirto">×¡×™×¨×˜×• (Sirto 2/4)</option>
                    <option value="tsifteteli">×¦×¤×˜×˜×œ×™ (Tsifteteli 4/4)</option>
                    <option value="kalamatianos">×§×œ××˜×™×× ×•×¡ (7/8)</option>
                </optgroup>
                <optgroup label="--- ××–×¨×—×™/×—×¤×œ×” (2/4) ---">
                    <option value="malfuf">××œ×¤×•×£ (Malfuf)</option>
                    <option value="ayoub">××™×•×‘/×–××¨ (Ayoub)</option>
                    <option value="fox">×¤×•×§×¡ (Fox)</option>
                    <option value="karachi">×§×¨××¦'×™ (Karachi)</option>
                    <option value="laf">×œ××£ (Laf)</option>
                </optgroup>
                <optgroup label="--- ××–×¨×—×™ (4/4 & ×›×‘×“) ---">
                    <option value="maksum">××§×¡×•× (Maksum)</option>
                    <option value="baladi">×‘×œ×“×™ (Baladi)</option>
                    <option value="saidi">×¡×¢×™×“×™ (Saidi)</option>
                    <option value="masmoudi">××¡××•×“×™ ×’×“×•×œ (Masmoudi 8/4)</option>
                    <option value="samai">×¡×××¢×™ (Samai 10/8)</option>
                </optgroup>
                <optgroup label="--- ××¢×¨×‘×™ ---">
                    <option value="rock">×¨×•×§ (Rock 4/4)</option>
                    <option value="waltz">×•××œ×¡ (Waltz 3/4)</option>
                    <option value="disco">×“×™×¡×§×• (Disco 4/4)</option>
                    <option value="reggae">×¨×’××™×™ (Reggae 4/4)</option>
                </optgroup>
            </select>
            <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa;">
                <span>BPM: <span id="bpmDisplay">120</span></span>
                <input type="range" id="bpmSlider" min="40" max="220" value="120" style="width:60%" oninput="updateBPM()">
            </div>
            <button id="rhythmPlayBtn" class="btn-gold" style="width:100%; margin-top:5px;" onclick="toggleRhythmPlay()">â–¶ × ×’×Ÿ ××§×¦×‘</button>
            <div id="beatVis" style="margin-top:8px; text-align:center; height:12px; display:flex; justify-content:center; gap:2px;"></div>
            
            <div class="mp3-zone">
                <div style="font-size:11px; color:#888; margin-bottom:3px;">× ×’×Ÿ ×œ×™×•×•×™ (Backing Track)</div>
                <label for="fileUpload" class="file-label">ğŸ“‚ ×˜×¢×Ÿ ×©×™×¨ (MP3/WAV)</label>
                <input type="file" id="fileUpload" style="display:none;" accept="audio/*" onchange="loadAudioFile(this)">
                <div id="fileName" style="font-size:10px; color:#ffca28; margin-bottom:2px; text-align:center;"></div>
                <audio id="audioPlayer" controls></audio>
            </div>
        </div>
    </div>

    <div class="inst-wrap" id="inst">
        <div class="head" id="head"></div>
        <div class="nut" style="width:14px; background:#ccc; z-index:5;"></div>
        <div class="neck" id="neck"></div>
    </div>

    <div class="workspace">
        <div class="panel panel-l">
            <div class="title">
                <span style="color:#ffb300;">× ×’×Ÿ ×•×¢×¨×•×š</span>
                <div style="display:flex; gap:5px;">
                    <button class="btn-gold" onclick="playAll()">â–¶ × ×’×Ÿ</button>
                    <button style="background:#d32f2f; border:none; color:white;" onclick="stop()">â– </button>
                    <button style="background:#546e7a; border:none; color:white;" onclick="clearSeq()">× ×§×” ×”×›×œ</button>
                </div>
            </div>
            <div style="font-size:11px; color:#888;">×× ×’×™× ×” (Melody)</div>
            <div class="timeline" id="melTrack"></div>
            <div style="font-size:11px; color:#888;">××§×•×¨×“×™× (Harmony)</div>
            <div class="timeline" id="chordTrack"></div>
            <div style="margin-top:auto; padding-top:10px; border-top:1px solid #333; display:flex; gap:5px;">
                <input id="saveName" placeholder="×©×..." style="flex:1; background:#333; color:white; border:1px solid #555;">
                <button class="btn-gold" onclick="save()">×©××•×¨</button>
                <select id="saveList" style="width:120px;"></select>
                <button class="btn-act" onclick="load()">×˜×¢×Ÿ</button>
                <button style="background:#d32f2f; border:none; color:white;" onclick="del()">X</button>
            </div>
        </div>

        <div class="panel panel-r">
            <div class="title">Inspector</div>
            <div class="ins-box">
                <div id="insName" class="ins-name">---</div>
                <div id="insNotes" class="ins-notes">×‘×—×¨ ××§×•×¨×“</div>
                <div style="display:flex; gap:10px; justify-content:center; align-items:center; margin-bottom:8px;">
                    <button class="btn-act" onclick="mvPos(-1)">â—€</button>
                    <span id="posLabel" style="font-size:11px; color:#ffca28;">Pos</span>
                    <button class="btn-act" onclick="mvPos(1)">â–¶</button>
                </div>
                <button id="btnEdit" class="btn-edit" onclick="toggleEdit()">××¦×‘ ×¢×¨×™×›×”: ×›×‘×•×™</button>
                <div style="display:flex; gap:5px; justify-content:center; margin-top:8px;">
                    <button class="btn-act" style="width:70px;" onclick="mod('inv')">Inversion</button>
                    <button class="btn-act" style="width:70px;" onclick="mod('7')">Add 7</button>
                </div>
            </div>
            <button class="btn-gold" style="width:100%; margin-bottom:5px;" onclick="addIns()">×”×•×¡×£ ×œ× ×’×Ÿ â‡©</button>
            <div id="chordGrid" class="chord-grid"></div>
        </div>
    </div>

    <script>
        window.onerror = function(m) { document.getElementById('err').style.display='block'; document.getElementById('err').innerText="×©×’×™××”: "+m; };

        const N=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'], T=[0,5,9,2], FQ=[130.8,174.6,220.0,293.7];
        const SCALES = {
            "--- ×™×•×•× ×™ ---": {'hitzaz':[0,1,4,5,7,8,10],'hitzazkiar':[0,1,4,5,7,8,11],'piraiotikos':[0,1,4,6,7,8,11],'niavent':[0,2,3,5,7,8,10],'oussak':[0,1,3,5,7,8,10],'kourdi':[0,1,3,5,7,8,10],'sabah':[0,1,3,4,7,8,10],'rast':[0,2,4,5,7,9,11],'houzam':[0,3,4,7,8,11],'segah':[0,3,4,7,8,10],'tabani':[0,2,4,5,7,9,11]},
            "--- ×¢×¨×‘×™ ---": {'bayati':[0,1,3,5,7,8,10],'saba':[0,1,3,4,6,8,10],'nahawand':[0,2,3,5,7,8,11],'ajam':[0,2,4,5,7,9,11],'siga':[0,3,4,7,8,10],'kard':[0,1,3,5,7,8,10],'mahur':[0,2,4,5,7,9,11],'nikriz':[0,2,3,6,7,8,10]},
            "--- ××¢×¨×‘×™ ---": {'major':[0,2,4,5,7,9,11],'minor':[0,2,3,5,7,8,10],'harmonic':[0,2,3,5,7,8,11],'dorian':[0,2,3,5,7,9,10],'phrygian':[0,1,3,5,7,8,10],'lydian':[0,2,4,6,7,9,11]}
        };

        let ctx, mel=[], ch=[], isPlay=false, actCh=null, pos=[], pIdx=0, isEdit=false;

        window.onload = () => {
            const rs = document.getElementById('rootSelect');
            N.forEach((n,i)=>{let o=document.createElement('option'); o.value=i; o.text=n; if(n==='D')o.selected=true; rs.appendChild(o)});
            const ss = document.getElementById('scaleSelect');
            for(let g in SCALES){
                let gr=document.createElement('optgroup'); gr.label=g;
                for(let k in SCALES[g]){let o=document.createElement('option'); o.value=g+'|'+k; o.text=k; gr.appendChild(o)}
                ss.appendChild(gr);
            }
            mkNeck(); run(); ls(); makeDraggable(document.getElementById('rhythmPanel'));
        };

        function mkNeck() {
            const h=document.getElementById('head'), n=document.getElementById('neck'), K=1-Math.pow(0.9438,20);
            for(let i=1; i<=19; i++){
                let p=((1-Math.pow(0.9438,i))/K)*100, c=((1-Math.pow(0.9438,i)+1-Math.pow(0.9438,i-1))/2/K)*100;
                let l=document.createElement('div'); l.className='line'; l.style.left=p+'%'; n.appendChild(l);
                let nm=document.createElement('div'); nm.className='num flip-fix'; nm.innerText=i; nm.style.left=c+'%'; n.appendChild(nm);
                if([3,5,7,9,15,17,19].includes(i)){let d=document.createElement('div'); d.className='dot'; d.style.left=c+'%'; n.appendChild(d);}
                if(i===12){let d1=document.createElement('div');d1.className='dot t';d1.style.left=c+'%';n.appendChild(d1);let d2=document.createElement('div');d2.className='dot b';d2.style.left=c+'%';n.appendChild(d2);}
            }
            for(let i=3;i>=0;i--){ mkRow(i,h,1); mkRow(i,n,0); }
        }
        function mkRow(i,p,hd){ let d=document.createElement('div'); d.className='course'; d.dataset.i=i; let c=i<2?'str-gold':'str-silver'; let thk = i===0?'h-thick':(i===1?'h-med':'h-thin'); let s1 = `<div class="string ${c} ${thk}"></div>`; let s2 = `<div class="string str-silver h-thin"></div>`; d.innerHTML = s1 + s2; if(hd) d.innerHTML+=`<div class="char flip-fix">${N[T[i]]}</div>`; p.appendChild(d); }
        function run() { clearBoard(); actCh=null; pos=[]; pIdx=0; updIns(); isEdit=false; updEditBtn(); let rt=parseInt(document.getElementById('rootSelect').value); let v=document.getElementById('scaleSelect').value.split('|'); let ints=SCALES[v[0]][v[1]], nts=ints.map(x=>(rt+x)%12); for(let s=0;s<4;s++){ let b=T[s]; for(let f=0;f<=19;f++){ let n=(b+f)%12; if(nts.includes(n)) mkMrk(s,f,n,n===rt); } } mkCh(rt, ints); }
        function mkMrk(s,f,n,r) { let c=f===0?document.getElementById('head'):document.getElementById('neck'); let rw=Array.from(c.querySelectorAll('.course')).find(x=>x.dataset.i==s); if(rw){ let m=document.createElement('div'); m.className='marker flip-fix '+(r?'root':''); m.innerText=N[n]; m.dataset.s=s; m.dataset.f=f; posElem(m,f); m.onclick = (e) => { e.stopPropagation(); if(isEdit && actCh) { toggleNoteInChord(n); } else { let fr=FQ[s]*Math.pow(2,f/12); play(fr); flash(m); mel.push({n:N[n],s,f,fr}); rend(); } }; rw.appendChild(m); } }
        function posElem(el,f){ if(f===0) el.style.left='45px'; else { const K=1-Math.pow(0.9438,20); let p=((1-Math.pow(0.9438,f))/K)*100, pr=((1-Math.pow(0.9438,f-1))/K)*100; el.style.left=((p+pr)/2)+'%'; } }
        function mkCh(rt,ints) { let g=document.getElementById('chordGrid'); g.innerHTML=''; for(let i=0;i<ints.length;i++){ let n1=(rt+ints[i])%12, n3=(rt+ints[(i+2)%ints.length])%12, n5=(rt+ints[(i+4)%ints.length])%12; let t=(n3-n1+12)%12===4?'':'m'; let b=document.createElement('button'); b.className='chord-btn'; b.innerText=N[n1]+t; let o={name:N[n1]+t, notes:[n1,n3,n5]}; b.onclick=()=>{ loadCh(o); }; g.appendChild(b); } }
        function loadCh(o) { actCh=JSON.parse(JSON.stringify(o)); calcPos(); pIdx=0; updIns(); playPos(); showPos(); }
        function toggleEdit() { if(!actCh) return alert("×‘×—×¨ ××§×•×¨×“"); isEdit = !isEdit; updEditBtn(); }
        function updEditBtn() { let b = document.getElementById('btnEdit'); if(isEdit) { b.classList.add('active'); b.innerText = "×¢×¨×™×›×” ×¤×¢×™×œ×”"; } else { b.classList.remove('active'); b.innerText = "××¦×‘ ×¢×¨×™×›×”: ×›×‘×•×™"; } }
        function toggleNoteInChord(n) { let idx = actCh.notes.indexOf(n); if(idx > -1) actCh.notes.splice(idx, 1); else actCh.notes.push(n); actCh.name = "Custom"; calcPos(); pIdx=0; updIns(); showPos(); play(440); }
        function calcPos() { pos=[]; let ranges=[[0,5],[4,9],[7,12]]; ranges.forEach(rng=>{ let p=[]; for(let s=0;s<4;s++){ let b=T[s]; for(let f=rng[0];f<=rng[1];f++){ let n=(b+f)%12; if(actCh.notes.includes(n)){ p.push({s,f,n,fr:FQ[s]*Math.pow(2,f/12)}); break; } } } if(p.length>=1) pos.push(p); }); if(!pos.length) pos.push([]); }
        function mvPos(d){ if(!pos.length)return; pIdx=(pIdx+d+pos.length)%pos.length; updIns(); playPos(); showPos(); }
        function updIns(){ if(!actCh){ document.getElementById('insName').innerText="---"; return;} document.getElementById('insName').innerText=actCh.name; document.getElementById('insNotes').innerText=actCh.notes.map(x=>N[x]).join('-'); document.getElementById('posLabel').innerText=(pIdx+1)+"/"+pos.length; }
        function mod(t){ if(!actCh)return; if(t==='inv'){actCh.notes.push(actCh.notes.shift());actCh.name+='/I';} if(t==='7'){let l=actCh.notes[actCh.notes.length-1];actCh.notes.push((l+3)%12);actCh.name+='7';} calcPos(); pIdx=0; updIns(); playPos(); showPos(); }
        function showPos() { document.querySelectorAll('.chord-dot').forEach(e=>e.remove()); if(!pos[pIdx]) return; pos[pIdx].forEach(p=>{ let c=p.f===0?document.getElementById('head'):document.getElementById('neck'); let r=Array.from(c.querySelectorAll('.course')).find(x=>x.dataset.i==p.s); if(r){ let d=document.createElement('div'); d.className='chord-dot flip-fix'; d.innerText=N[p.n]; posElem(d,p.f); r.appendChild(d); } }); }
        function playPos() { if(pos[pIdx]) pos[pIdx].forEach((p,i)=>setTimeout(()=>play(p.fr),i*40)); }
        function addIns(){ if(actCh){ ch.push({name:actCh.name, pts:pos[pIdx]}); rend(); } }
        function clearSeq(){ mel=[]; ch=[]; rend(); }
        function removeMel(idx) { mel.splice(idx,1); rend(); }
        function removeCh(idx) { ch.splice(idx,1); rend(); }
        function rend() { let tm=document.getElementById('melTrack'), tc=document.getElementById('chordTrack'); tm.innerHTML=''; tc.innerHTML=''; mel.forEach((x,i)=>{ let d=document.createElement('div'); d.className='seq-item'; d.id='m'+i; d.innerHTML=`${x.n}<br>S${x.s+1}<div class="del-note" onclick="removeMel(${i})">Ã—</div>`; d.onclick=(e)=>{ if(e.target.className!=='del-note') play(x.fr); }; tm.appendChild(d); }); ch.forEach((x,i)=>{ let d=document.createElement('div'); d.className='seq-item chord-item'; d.id='c'+i; d.innerHTML=`${x.name}<div class="del-note" onclick="removeCh(${i})">Ã—</div>`; d.onclick=(e)=>{ if(e.target.className!=='del-note') x.pts.forEach((p,j)=>setTimeout(()=>play(p.fr),j*40)); }; tc.appendChild(d); }); }
        function playAll(){ if(isPlay)return; isPlay=true; if(!ctx)ctx=new(window.AudioContext||window.webkitAudioContext)(); ctx.resume(); let idx=0; function loop(){ if(!isPlay)return; document.querySelectorAll('.active').forEach(e=>e.classList.remove('active')); if(idx<mel.length){ let m=mel[idx]; play(m.fr); let e=document.getElementById('m'+idx); if(e){e.classList.add('active'); e.scrollIntoView({inline:'center'});} let mrk=document.querySelector(`.marker[data-s="${m.s}"][data-f="${m.f}"]`); if(mrk) flash(mrk); let ci=Math.floor(idx/4); if(idx%4===0 && ci<ch.length){ let c=ch[ci]; c.pts.forEach((p,j)=>setTimeout(()=>play(p.fr),j*40)); let ce=document.getElementById('c'+ci); if(ce)ce.classList.add('active'); document.querySelectorAll('.chord-dot').forEach(e=>e.remove()); c.pts.forEach(p=>{ let co=p.f===0?document.getElementById('head'):document.getElementById('neck'); let ro=Array.from(co.querySelectorAll('.course')).find(x=>x.dataset.i==p.s); if(ro){let d=document.createElement('div'); d.className='chord-dot flip-fix'; d.innerText=N[p.n]; posElem(d,p.f); ro.appendChild(d);} }); } idx++; setTimeout(loop,400); } else stop(); } loop(); }
        function stop(){ isPlay=false; }
        function play(f){ if(!ctx)ctx=new(window.AudioContext||window.webkitAudioContext)(); ctx.resume(); let o=ctx.createOscillator(), g=ctx.createGain(); o.type='triangle'; o.frequency.value=f; g.gain.setValueAtTime(0,ctx.currentTime); g.gain.linearRampToValueAtTime(0.2,ctx.currentTime+0.05); g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.4); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.4); }
        function flash(e){ e.classList.add('flash'); setTimeout(()=>e.classList.remove('flash'),200); }
        function clearBoard(){ document.querySelectorAll('.marker, .chord-dot').forEach(e=>e.remove()); }
        function toggleFlip(){ document.getElementById('inst').classList.toggle('flip'); }
        function save(){ let n=document.getElementById('saveName').value; if(n){localStorage.setItem('bz25_'+n,JSON.stringify({m:mel,c:ch})); ls(); alert('× ×©××¨');} }
        function load(){ let n=document.getElementById('saveList').value; if(n){let d=JSON.parse(localStorage.getItem(n)); if(d){mel=d.m; ch=d.c; rend();}} }
        function del(){ let n=document.getElementById('saveList').value; if(n&&confirm('?')){localStorage.removeItem(n); ls();} }
        function ls(){ let s=document.getElementById('saveList'); s.innerHTML=''; for(let i=0;i<localStorage.length;i++){let k=localStorage.key(i); if(k.startsWith('bz25_')){let o=document.createElement('option'); o.value=k; o.text=k.replace('bz25_',''); s.appendChild(o);}}}

        // --- RHYTHM MACHINE (V28 Expanded) ---
        let rhythmInterval, isRhythmPlaying = false;
        
        // ××§×¦×‘×™× ××•×¨×—×‘×™×
        const RHYTHMS = {
            // 9/8 ×•-3/4
            'zeibekiko': [1,0,0,2,0,1,0,2,0,2,0,0], 
            'aptaliko': [1,0,0,1,0,0,2,0,0], // 9/8 ×”×¤×•×š (×“×•×’××” ×‘×¡×™×¡×™×ª)
            'karsilamas': [1,0,2,0,2,0,1,0,0], // 2+2+2+3
            'kamilieriko': [1,0,0,2,0,0,1,0,2], // 9/8 ××™×˜×™
            'tsamiko': [1,0,2,0,2,0], // 3/4 ××• 6/8

            // 4/4 ×•-2/4 ×™×•×•× ×™
            'hasapiko': [1,0,2,0,1,0,2,0],
            'hasaposirto': [1,0,2,0,2,0,1,0], // 2/4 ××”×™×¨
            'sirto': [1,0,2,0,2,0,1,0], // ×“×•××” ×œ×—×¡×¤×•×¡×™×¨×˜×• ××‘×œ ×”×“×’×© ×©×•× ×” ×‘× ×’×™× ×”
            'tsifteteli': [1,0,2,0,2,0,1,0,2,0,0,0],
            'kalamatianos': [1,0,2,1,0,2,0], // 7/8

            // 2/4 ××–×¨×—×™ (××”×™×¨)
            'malfuf': [1,0,0,2], // ××”×™×¨ ×××•×“
            'ayoub': [1,0,0,2], // ×–××¨ (×“×•××” ×œ××œ×¤×•×£ ××‘×œ ×›×‘×“ ×™×•×ª×¨)
            'fox': [1,0,2,0,1,0,2,0],
            'karachi': [2,0,1,0], // ×”×¤×•×š (×˜××§-×“×•×)
            'laf': [1,0,2,0],

            // 4/4 ×•××•×¨×›×‘×™×
            'maksum': [1,0,2,0,0,2,1,0,2,0,0,0],
            'baladi': [1,0,1,0,0,2,1,0,0,0,2,0],
            'saidi': [1,0,2,0,1,1,0,0,2,0,0,0],
            'masmoudi': [1,0,1,0,0,0,2,0,1,0,0,0,2,0,0,0], // 8/4
            'samai': [1,0,0,2,0,1,0,2,0,0], // 10/8

            // ××¢×¨×‘×™
            'rock': [1,0,2,0,1,0,2,0],
            'waltz': [1,0,2,0,2,0],
            'disco': [1,0,0,0,2,0,0,0],
            'reggae': [0,0,2,0,1,0,2,0]
        };

        function toggleRhythm() {
            let p = document.getElementById('rhythmPanel');
            p.style.display = (p.style.display === 'block') ? 'none' : 'block';
        }

        function toggleRhythmPlay() {
            if(isRhythmPlaying) {
                clearInterval(rhythmInterval); isRhythmPlaying = false;
                document.getElementById('rhythmPlayBtn').innerText = "â–¶ × ×’×Ÿ ××§×¦×‘";
            } else {
                let bpm = document.getElementById('bpmSlider').value;
                startRhythm(bpm);
                isRhythmPlaying = true;
                document.getElementById('rhythmPlayBtn').innerText = "â–  ×¢×¦×•×¨";
            }
        }

        function updateBPM() {
            let val = document.getElementById('bpmSlider').value;
            document.getElementById('bpmDisplay').innerText = val;
            if(isRhythmPlaying) { clearInterval(rhythmInterval); startRhythm(val); }
        }

        function startRhythm(bpm) {
            if(!ctx) ctx=new(window.AudioContext||window.webkitAudioContext)(); ctx.resume();
            let pat = RHYTHMS[document.getElementById('rhythmStyle').value] || RHYTHMS['zeibekiko'];
            updateBeatVis(pat.length);
            let i = 0;
            // ×—×™×©×•×‘ ×”××”×™×¨×•×ª (××•×ª×× ×œ×—×œ×•×§×” ×’×¡×” ×©×œ ×©××™× ×™×•×ª/×¨×‘×¢×™×)
            let speed = (60000 / bpm) / 2; 
            if(pat.length < 5) speed = (60000 / bpm); // ×œ××§×¦×‘×™× ×§×¦×¨×™× (2/4) × ××˜ ×§×¦×ª ××ª ×”×œ×•×¤

            rhythmInterval = setInterval(()=>{
                document.querySelectorAll('.beat-dot').forEach((d,ix)=>d.classList.toggle('active', ix===i));
                if(pat[i]===1) playDrum(150, 0.01); // Dum
                if(pat[i]===2) playDrum(800, 0.05); // Tak
                i = (i+1)%pat.length;
            }, speed);
        }

        function playDrum(freq, len) {
            let o=ctx.createOscillator(), g=ctx.createGain();
            o.frequency.value=freq; 
            g.gain.setValueAtTime(1,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.1);
            o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.1);
        }

        function updateBeatVis(len) {
            let d = document.getElementById('beatVis'); d.innerHTML='';
            for(let i=0;i<len;i++) { 
                let s=document.createElement('span'); 
                s.className='beat-dot ' + (i===0 ? 'strong':''); // ×”×“×’×©×ª ×”-1
                d.appendChild(s); 
            }
        }

        function changeStyle() { if(isRhythmPlaying) { clearInterval(rhythmInterval); startRhythm(document.getElementById('bpmSlider').value); } }

        // --- MP3 Player Logic ---
        function loadAudioFile(input) {
            const file = input.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                const player = document.getElementById('audioPlayer');
                player.src = url;
                document.getElementById('fileName').innerText = file.name;
            }
        }

        // --- Draggable Logic ---
        function makeDraggable(el) {
            let pos1=0, pos2=0, pos3=0, pos4=0;
            document.getElementById('dragHeader').onmousedown = dragMouseDown;
            function dragMouseDown(e) {
                e = e || window.event; e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            function elementDrag(e) {
                e = e || window.event; e.preventDefault();
                pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
                pos3 = e.clientX; pos4 = e.clientY;
                el.style.top = (el.offsetTop - pos2) + "px";
                el.style.left = (el.offsetLeft - pos1) + "px";
            }
            function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
        }
    </script>
</body>

</html>
