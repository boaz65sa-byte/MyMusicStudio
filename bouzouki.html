<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=1000, initial-scale=1">
<title>Bouzouki V25 - Final Fixed</title>
<style>
  body{background:#121212;color:#eee;font-family:sans-serif;margin:0;padding:5px;height:100vh;overflow:hidden;display:flex;flex-direction:column;align-items:center}
  *{box-sizing:border-box;user-select:none}
  
  /* ממשק */
  .top-bar{background:#1e1e1e;padding:10px;border-radius:8px;border:1px solid #333;display:flex;gap:10px;margin-bottom:10px}
  select,button{background:#333;color:#fff;border:1px solid #555;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:14px}
  .btn-gold{background:#ffb300;color:#000;font-weight:bold;border:none}
  .btn-act{background:#455a64;border-color:#607d8b}
  .btn-edit{width:100%;background:#222;border:1px solid #d32f2f;color:#e57373;margin-top:5px}
  .btn-edit.active{background:#d32f2f;color:white;font-weight:bold}

  /* בוזוקי - מבנה */
  .inst-wrap{direction:ltr;position:relative;width:960px;height:250px;background:#050505;border:4px solid #4e342e;border-radius:10px;display:flex;overflow:hidden;margin-bottom:10px;flex-shrink:0}
  
  /* --- היפוך מושלם --- */
  .inst-wrap.flip { transform: scaleX(-1); }
  .inst-wrap.flip .flip-fix { transform: scaleX(-1); display:inline-flex; justify-content:center; align-items:center; }

  .head{width:90px;background:#1a1005;border-right:2px solid #333;position:relative;z-index:2}
  .neck{flex:1;background:linear-gradient(#3e2723,#150d0b);position:relative}
  .nut{width:12px;background:#ccc;z-index:5}

  /* גריף ומיתרים */
  .line{position:absolute;top:0;bottom:0;width:2px;background:#888;border-left:1px solid #aaa}
  .num{position:absolute;bottom:2px;width:20px;margin-left:-10px;text-align:center;font-size:10px;color:#8d6e63;font-weight:bold;display:flex;justify-content:center;}
  .dot{position:absolute;width:12px;height:12px;background:#ddd;border-radius:50%;top:50%;margin:-6px;opacity:0.7;box-shadow:0 0 5px rgba(255,255,255,0.3)}
  .dot.t{top:25%}.dot.b{top:75%}

  .course{position:relative;width:100%;height:25%;display:flex;flex-direction:column;justify-content:space-evenly;padding:3px 0}
  .string{width:100%;box-shadow:0 1px 2px #000;border-radius:2px}
  .str-gold{background:#ffb300;height:3px;border-bottom:1px solid #bf360c}
  .str-silver{background:#e0e0e0;height:1px;border-bottom:1px solid #616161}
  
  .char{position:absolute;left:15px;top:35%;color:#ffb300;font-size:18px;font-weight:bold;z-index:10;width:20px;text-align:center;display:flex;justify-content:center;}

  /* מרקרים ונקודות */
  .marker{position:absolute;width:24px;height:24px;background:radial-gradient(#4caf50,#2e7d32);border:2px solid white;border-radius:50%;top:50%;margin:-12px;z-index:20;display:flex;justify-content:center;align-items:center;font-size:11px;font-weight:bold;cursor:pointer;box-shadow:0 2px 4px #000}
  .marker.root{background:radial-gradient(#f44336,#c62828);z-index:21}
  .chord-dot{position:absolute;width:26px;height:26px;background:rgba(33,150,243,0.8);border:2px solid white;border-radius:50%;top:50%;margin:-13px;z-index:90;pointer-events:none;display:flex;justify-content:center;align-items:center;font-size:10px;color:white;font-weight:bold}
  .flash{background:#fff!important;box-shadow:0 0 20px #fff;transition:0.1s}

  /* פאנלים */
  .workspace{display:flex;gap:10px;width:960px;height:340px}
  .panel{background:#212121;border:1px solid #333;border-radius:8px;padding:10px;display:flex;flex-direction:column;overflow:hidden}
  .L{flex:2} .R{flex:1;min-width:300px;background:#263238}
  
  .ins-box{background:#000;padding:10px;border-radius:6px;text-align:center;margin-bottom:10px;border:1px solid #546e7a;min-height:130px;display:flex;flex-direction:column;justify-content:center}
  .chord-grid{display:flex;flex-wrap:wrap;gap:3px;overflow-y:auto;align-content:flex-start;flex:1;padding:5px;background:rgba(0,0,0,.2);max-height:120px}
  .chord-btn{background:#37474f;border:1px solid #546e7a;color:#ccc;margin:0;font-size:11px;flex-grow:1;min-width:45px;padding:6px}
  .chord-btn:hover{background:#ffb300;color:black}

  .timeline{background:#121212;height:45px;border:1px solid #333;display:flex;align-items:center;padding:0 5px;gap:3px;overflow-x:auto;margin-bottom:5px}
  .seq-item{background:#424242;padding:3px;font-size:10px;min-width:40px;text-align:center;border-radius:3px;border:1px solid #555;cursor:pointer;position:relative;margin-right:4px}
  .seq-item.active{background:#ffb300;color:black}
  .del-note{position:absolute;top:-6px;right:-6px;background:red;color:white;width:14px;height:14px;font-size:10px;line-height:12px;border-radius:50%;display:none;font-weight:bold;border:1px solid white}
  .seq-item:hover .del-note{display:block}

  #err{display:none;position:fixed;top:0;left:0;width:100%;background:red;color:#fff;text-align:center;padding:5px;z-index:999}
</style>
</head>
<body>
<div id="err"></div>

<div class="top-bar">
  <label>שורש:</label><select id="rt" onchange="run()"></select>
  <label>סולם:</label><select id="sc" onchange="run()"></select>
  <button class="btn-gold" onclick="run()">טען</button>
  <button class="btn-act" onclick="flip()">היפוך</button>
  <button class="btn-act" onclick="clrB()">נקה</button>
</div>

<div class="inst-wrap" id="inst">
  <div id="head" class="head"></div>
  <div class="nut"></div>
  <div id="neck" class="neck"></div>
</div>

<div class="workspace">
  <div class="panel L">
    <div style="display:flex;justify-content:space-between;color:#ffb300;margin-bottom:5px;font-weight:bold;font-size:12px">
      ערוצי נגינה
      <div><button class="btn-gold" onclick="playAll()">▶</button><button onclick="stop()">■</button><button onclick="clrS()">נקה הכל</button></div>
    </div>
    <div style="font-size:10px;color:#888">Melody</div><div id="tml" class="timeline"></div>
    <div style="font-size:10px;color:#888">Harmony</div><div id="tch" class="timeline"></div>
    <div style="margin-top:auto;display:flex;gap:5px;border-top:1px solid #444;padding-top:5px">
      <input id="sn" placeholder="שם..." style="flex:1;background:#333;color:#fff;border:1px solid #555">
      <button class="btn-gold" onclick="save()">שמור</button>
      <select id="sl" style="width:100px"></select>
      <button onclick="load()">טען</button>
      <button style="background:#d32f2f;border:none" onclick="del()">X</button>
    </div>
  </div>

  <div class="panel R">
    <div style="text-align:center;color:#ffb300;margin-bottom:5px;font-size:12px;font-weight:bold">Inspector</div>
    <div class="ins-box">
      <div id="inm" style="font-size:24px;font-weight:bold;color:#fff;margin-bottom:2px">---</div>
      <div id="int" style="font-size:13px;color:#aaa;margin-bottom:8px">בחר אקורד</div>
      <div style="display:flex;gap:10px;justify-content:center;margin-bottom:5px">
        <button class="btn-act" onclick="mvPos(-1)">◀</button><span id="ips" style="font-size:12px;color:#ffca28;align-self:center">Pos</span><button class="btn-act" onclick="mvPos(1)">▶</button>
      </div>
      <button id="bedit" class="btn-edit" onclick="tEdit()">מצב עריכה: כבוי</button>
      <div style="display:flex;gap:5px;justify-content:center;margin-top:5px">
        <button class="btn-act" onclick="mod('inv')">Inv</button><button class="btn-act" onclick="mod('7')">7th</button>
      </div>
    </div>
    <button class="btn-gold" style="width:100%;margin-bottom:5px" onclick="addIns()">הוסף לנגן ⇩</button>
    <div id="grd" class="chord-grid"></div>
  </div>
</div>

<script>
window.onerror=function(m){document.getElementById('err').style.display='block';document.getElementById('err').innerText="שגיאה: "+m};

const N=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'], T=[0,5,9,2], FQ=[130.8,174.6,220.0,293.7];
const SCL={
 "יווני":{'hitzaz':[0,1,4,5,7,8,10],'hitzazkiar':[0,1,4,5,7,8,11],'piraiotikos':[0,1,4,6,7,8,11],'niavent':[0,2,3,5,7,8,10],'oussak':[0,1,3,5,7,8,10],'kourdi':[0,1,3,5,7,8,10],'sabah':[0,1,3,4,7,8,10],'rast':[0,2,4,5,7,9,11],'houzam':[0,3,4,7,8,11],'segah':[0,3,4,7,8,10],'tabani':[0,2,4,5,7,9,11]},
 "ערבי":{'bayati':[0,1,3,5,7,8,10],'saba':[0,1,3,4,6,8,10],'nahawand':[0,2,3,5,7,8,11],'ajam':[0,2,4,5,7,9,11],'siga':[0,3,4,7,8,10],'kard':[0,1,3,5,7,8,10],'mahur':[0,2,4,5,7,9,11]},
 "מערבי":{'major':[0,2,4,5,7,9,11],'minor':[0,2,3,5,7,8,10],'harmonic':[0,2,3,5,7,8,11],'dorian':[0,2,3,5,7,9,10],'phrygian':[0,1,3,5,7,8,10]}
};

let ctx, oscs=[], mel=[], ch=[], isP=false, actC=null, pos=[], pi=0, isEd=false;

window.onload=()=>{
 const r=document.getElementById('rt'); N.forEach((n,i)=>{let o=document.createElement('option');o.value=i;o.text=n;if(n==='D')o.selected=true;r.appendChild(o)});
 const s=document.getElementById('sc');
 for(let g in SCL){let gr=document.createElement('optgroup');gr.label=g;for(let k in SCL[g]){let o=document.createElement('option');o.value=g+'|'+k;o.text=k;gr.appendChild(o)}s.appendChild(gr)}
 mkNeck(); run(); ls();
};

function mkNeck(){
 const h=document.getElementById('head'), n=document.getElementById('neck'), K=1-Math.pow(0.9438,20);
 const gp=i=>((1-Math.pow(0.9438,i))/K)*100;
 for(let i=1;i<=19;i++){
  let p=gp(i), c=(gp(i)+gp(i-1))/2;
  let l=document.createElement('div');l.className='line';l.style.left=p+'%';n.appendChild(l);
  let nm=document.createElement('div');nm.className='num flip-fix';nm.innerText=i;nm.style.left=c+'%';n.appendChild(nm);
  if([3,5,7,9,15,17,19].includes(i)){let d=document.createElement('div');d.className='dot';d.style.left=c+'%';n.appendChild(d)}
  if(i===12){let d1=document.createElement('div');d1.className='dot t';d1.style.left=c+'%';n.appendChild(d1);let d2=document.createElement('div');d2.className='dot b';d2.style.left=c+'%';n.appendChild(d2)}
 }
 for(let i=3;i>=0;i--){ mkRow(i,h,1); mkRow(i,n,0); }
}
function mkRow(i,p,hd){
 let d=document.createElement('div');d.className='course';d.dataset.i=i;
 let c=i<2?'str-gold':'str-silver';
 d.innerHTML=`<div class="string ${c}"></div><div class="string str-silver"></div>`;
 if(hd) d.innerHTML+=`<div class="char flip-fix">${N[T[i]]}</div>`;
 p.appendChild(d);
}

function run(){
 clrB(); actC=null; pos=[]; pi=0; uiIns(); isEd=false; uiEd();
 let rt=parseInt(document.getElementById('rt').value);
 let v=document.getElementById('sc').value.split('|'), ints=SCL[v[0]][v[1]];
 let nts=ints.map(x=>(rt+x)%12);
 for(let s=0;s<4;s++){
  let b=T[s];
  for(let f=0;f<=19;f++){
   let n=(b+f)%12; if(nts.includes(n)) mkM(s,f,n,n===rt);
  }
 }
 mkCh(rt, ints);
}

function mkM(s,f,n,r){
 let c=f===0?document.getElementById('head'):document.getElementById('neck');
 let row=Array.from(c.querySelectorAll('.course')).find(x=>x.dataset.i==s);
 if(row){
  let m=document.createElement('div'); m.className='marker flip-fix '+(r?'root':'');
  m.innerText=N[n]; m.dataset.s=s; m.dataset.f=f;
  posEl(m,f);
  m.onclick=(e)=>{
   e.stopPropagation();
   if(isEd && actC) togNote(n);
   else {
    let fr=FQ[s]*Math.pow(2,f/12); play(fr); m.classList.add('flash'); setTimeout(()=>m.classList.remove('flash'),150);
    mel.push({n:N[n],s,f,fr}); rnd();
   }
  };
  row.appendChild(m);
 }
}
function posEl(e,f){
 if(f===0)e.style.left='45px';
 else{ const K=1-Math.pow(0.9438,20); let p=((1-Math.pow(0.9438,f))/K)*100, pr=((1-Math.pow(0.9438,f-1))/K)*100; e.style.left=((p+pr)/2)+'%'; }
}

function mkCh(rt,ints){
 let g=document.getElementById('grd');g.innerHTML='';
 for(let i=0;i<ints.length;i++){
  let n1=(rt+ints[i])%12, n3=(rt+ints[(i+2)%ints.length])%12, n5=(rt+ints[(i+4)%ints.length])%12;
  let t=(n3-n1+12)%12===4?'':'m';
  let b=document.createElement('button');b.className='chord-btn';b.innerText=N[n1]+t;
  let o={name:N[n1]+t, ns:[n1,n3,n5]};
  b.onclick=()=>{ldCh(o)};g.appendChild(b);
 }
}

function ldCh(o){ actC=JSON.parse(JSON.stringify(o)); calP(); pi=0; uiIns(); plyP(); shP(); }
function tEdit(){ if(!actC)return alert('בחר אקורד'); isEd=!isEd; uiEd(); }
function uiEd(){ let b=document.getElementById('bedit'); if(isEd){b.classList.add('active');b.innerText='עריכה פעילה'}else{b.classList.remove('active');b.innerText='מצב עריכה: כבוי'} }
function togNote(n){
 let i=actC.ns.indexOf(n); if(i>-1)actC.ns.splice(i,1); else actC.ns.push(n);
 actC.name='Cust'; calP(); pi=0; uiIns(); shP(); play(440);
}

function calP(){
 pos=[]; let rng=[[0,5],[4,9],[7,12]];
 rng.forEach(r=>{
  let p=[]; for(let s=0;s<4;s++){
   let b=T[s]; for(let f=r[0];f<=r[1];f++){
    let n=(b+f)%12; if(actC.ns.includes(n)){p.push({s,f,n,fr:FQ[s]*Math.pow(2,f/12)});break}
   }
  }
  if(p.length>=1)pos.push(p);
 });
 if(!pos.length)pos.push([]);
}
function mvPos(d){if(!pos.length)return;pi=(pi+d+pos.length)%pos.length;uiIns();plyP();shP()}
function uiIns(){
 if(!actC){document.getElementById('inm').innerText='---';return}
 document.getElementById('inm').innerText=actC.name;
 document.getElementById('int').innerText=actC.ns.map(x=>N[x]).join('-');
 document.getElementById('ips').innerText=(pi+1)+"/"+pos.length;
}
function mod(t){
 if(!actC)return;
 if(t==='inv'){actC.ns.push(actC.ns.shift());actC.name+='/I'}
 if(t==='7'){let l=actC.ns[actC.ns.length-1];actC.ns.push((l+3)%12);actC.name+='7'}
 calP(); pi=0; uiIns(); plyP(); shP();
}

function shP(){
 document.querySelectorAll('.chord-dot').forEach(e=>e.remove());
 if(!pos[pi])return;
 pos[pi].forEach(p=>{
  let c=p.f===0?document.getElementById('head'):document.getElementById('neck');
  let r=Array.from(c.querySelectorAll('.course')).find(x=>x.dataset.i==p.s);
  if(r){let d=document.createElement('div');d.className='chord-dot flip-fix';d.innerText=N[p.n];posEl(d,p.f);r.appendChild(d)}
 });
}
function plyP(){if(pos[pi])pos[pi].forEach((p,i)=>setTimeout(()=>play(p.fr),i*40))}

function addIns(){if(actC){ch.push({name:actC.name,pts:pos[pi]});rnd()}}
function clrS(){mel=[];ch=[];rnd()}
function delM(i){mel.splice(i,1);rnd()}
function delC(i){ch.splice(i,1);rnd()}

function rnd(){
 let tm=document.getElementById('tml'), tc=document.getElementById('tch'); tm.innerHTML=''; tc.innerHTML='';
 mel.forEach((x,i)=>{
  let d=document.createElement('div');d.className='seq-item';d.id='m'+i;
  d.innerHTML=`${x.n}<br>S${x.s+1}<div class="del-note" onclick="delM(${i})">×</div>`;
  d.onclick=(e)=>{if(e.target.className!=='del-note')play(x.fr)};tm.appendChild(d);
 });
 ch.forEach((x,i)=>{
  let d=document.createElement('div');d.className='seq-item';d.id='c'+i;d.style.minWidth='50px';d.style.background='#37474f';
  d.innerHTML=`${x.name}<div class="del-note" onclick="delC(${i})">×</div>`;
  d.onclick=(e)=>{if(e.target.className!=='del-note')x.pts.forEach((p,j)=>setTimeout(()=>play(p.fr),j*40))};tc.appendChild(d);
 });
}

function playAll(){
 if(isP)return;isP=true;if(!ctx)ctx=new(window.AudioContext||window.webkitAudioContext)();ctx.resume();
 let i=0;
 function l(){
  if(!isP)return;
  document.querySelectorAll('.active').forEach(e=>e.classList.remove('active'));
  if(i<mel.length){
   play(mel[i].fr); let e=document.getElementById('m'+i); if(e){e.classList.add('active');e.scrollIntoView({inline:'center'})}
   let m=document.querySelector(`.marker[data-s="${mel[i].s}"][data-f="${mel[i].f}"]`); if(m){m.classList.add('flash');setTimeout(()=>m.classList.remove('flash'),150)}
   
   let ci=Math.floor(i/4);
   if(i%4===0 && ci<ch.length){
    let c=ch[ci]; c.pts.forEach((p,j)=>setTimeout(()=>play(p.fr),j*40));
    let ce=document.getElementById('c'+ci); if(ce)ce.classList.add('active');
    document.querySelectorAll('.chord-dot').forEach(e=>e.remove());
    c.pts.forEach(p=>{
     let co=p.f===0?document.getElementById('head'):document.getElementById('neck');
     let ro=Array.from(co.querySelectorAll('.course')).find(x=>x.dataset.i==p.s);
     if(ro){let d=document.createElement('div');d.className='chord-dot flip-fix';d.innerText=N[p.n];posEl(d,p.f);ro.appendChild(d)}
    });
   }
   i++; setTimeout(l,400);
  } else stop();
 }
 l();
}
function stop(){isP=false}

function play(f){
 if(!ctx)ctx=new(window.AudioContext||window.webkitAudioContext)();ctx.resume();
 let o=ctx.createOscillator(), g=ctx.createGain();
 o.type='triangle';o.frequency.value=f;
 g.gain.setValueAtTime(0,ctx.currentTime);g.gain.linearRampToValueAtTime(0.2,ctx.currentTime+0.05);g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.4);
 o.connect(g);g.connect(ctx.destination);o.start();o.stop(ctx.currentTime+0.4);
}
function clrB(){document.querySelectorAll('.marker,.chord-dot').forEach(e=>e.remove())}
function flip(){document.getElementById('inst').classList.toggle('flip')}

function save(){let n=document.getElementById('sn').value;if(n){localStorage.setItem('bz25_'+n,JSON.stringify({m:mel,c:ch}));ls();alert('נשמר')}}
function load(){let n=document.getElementById('sl').value;if(n){let d=JSON.parse(localStorage.getItem(n));if(d){mel=d.m;ch=d.c;rnd()}}}
function del(){let n=document.getElementById('sl').value;if(n&&confirm('?')){localStorage.removeItem(n);ls()}}
function ls(){let s=document.getElementById('sl');s.innerHTML='';for(let i=0;i<localStorage.length;i++){let k=localStorage.key(i);if(k.startsWith('bz25_')){let o=document.createElement('option');o.value=k;o.text=k.replace('bz25_','');s.appendChild(o)}}}
</script>
</body>
</html>